# ============================================================
# Adelie Investment - 개발 환경
# 사용법: docker compose -f docker-compose.dev.yml up -d
# Docker Hub: docker compose -f docker-compose.dev.yml pull
# ============================================================

services:
  # --- PostgreSQL ---
  postgres:
    image: postgres:15
    ports:
      - "5433:5432"
    environment:
      POSTGRES_DB: narrative_invest
      POSTGRES_USER: narative
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U narative -d narrative_invest"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s

  # --- Redis ---
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s

  # --- Frontend (Vite Dev Server — HMR 즉시 반영) ---
  frontend:
    image: dorae222/adelie-frontend-dev:latest
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3001"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
    environment:
      - PROXY_TARGET=http://backend-api:8082
    depends_on:
      backend-api:
        condition: service_healthy
    restart: unless-stopped

  # --- FastAPI Backend ---
  backend-api:
    image: dorae222/adelie-backend-api:latest
    build:
      context: .
      dockerfile: fastapi/Dockerfile
    ports:
      - "8082:8082"
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://narative:password@postgres:5432/narrative_invest
      REDIS_URL: redis://redis:6379/1
      REDIS_HOST: redis
      REDIS_PORT: 6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./fastapi/app:/app/app
      - ./chatbot:/app/chatbot
      - ./datapipeline:/app/datapipeline
      - ./datapipeline/scripts:/app/scripts
      - ./datapipeline/collectors:/app/collectors
    command: uvicorn app.main:app --host 0.0.0.0 --port 8082 --reload
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8082/api/v1/health')\""]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # --- AI Pipeline (on-demand: docker compose --profile pipeline up ai-pipeline) ---
  ai-pipeline:
    image: dorae222/adelie-ai-pipeline:latest
    build:
      context: .
      dockerfile: datapipeline/Dockerfile
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://narative:password@postgres:5432/narrative_invest
      REDIS_URL: redis://redis:6379/1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    profiles:
      - pipeline

  # --- DB Migration (Alembic) ---
  db-migrate:
    image: dorae222/adelie-backend-api:latest
    build:
      context: .
      dockerfile: fastapi/Dockerfile
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://narative:password@postgres:5432/narrative_invest
    volumes:
      - ./database:/app/database
      - ./fastapi:/app/fastapi
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "cd /app/database && alembic upgrade heads"
    profiles:
      - migrate

volumes:
  postgres_data:
  redis_data:
