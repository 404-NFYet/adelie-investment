# ============================================================
# Adelie Investment - 개발 환경 (infra-server 공유 DB 연결)
# 사용법: docker compose -f docker-compose.dev.yml up
# ============================================================

services:
  # --- Frontend (React + Vite + Nginx) ---
  frontend:
    build:
      context: ./frontend
      args:
        VITE_FASTAPI_URL: ""
        VITE_SPRING_URL: ""
    ports:
      - "3001:80"
    depends_on:
      - backend-api
      - backend-spring
    restart: unless-stopped

  # --- FastAPI Backend ---
  backend-api:
    build:
      context: .
      dockerfile: fastapi/Dockerfile
    ports:
      - "8082:8082"
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://narative:password@10.10.10.10:5432/narrative_invest
      REDIS_URL: redis://10.10.10.10:6379/1
      REDIS_HOST: 10.10.10.10
      REDIS_PORT: 6379
      MINIO_ENDPOINT: http://10.10.10.10:9000
    volumes:
      - ./fastapi/app:/app/app  # 핫 리로드
      - ./chatbot:/app/chatbot  # 챗봇 모듈 공유
      - ./datapipeline/scripts:/app/scripts  # 파이프라인 스크립트
      - ./datapipeline/collectors:/app/collectors  # 데이터 수집기
      - ./datapipeline/prompts:/app/datapipeline/prompts  # 파이프라인 프롬프트
    command: uvicorn app.main:app --host 0.0.0.0 --port 8082 --reload
    restart: unless-stopped
    develop:
      watch:
        - action: sync
          path: ./fastapi/app
          target: /app/app
        - action: rebuild
          path: ./fastapi/requirements.txt

  # --- Spring Boot Backend ---
  backend-spring:
    build: ./springboot
    ports:
      - "8083:8080"
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://10.10.10.10:5432/narrative_invest
      SPRING_DATASOURCE_USERNAME: narative
      SPRING_DATASOURCE_PASSWORD: password
      JWT_SECRET: ${JWT_SECRET:-narrative-invest-jwt-secret-change-in-production}
    restart: unless-stopped

  # --- AI Pipeline (on-demand) ---
  ai-pipeline:
    build:
      context: .
      dockerfile: datapipeline/Dockerfile
    env_file: .env
    environment:
      DATABASE_URL: postgresql+asyncpg://narative:password@10.10.10.10:5432/narrative_invest
      REDIS_URL: redis://10.10.10.10:6379/1
    profiles:
      - pipeline
