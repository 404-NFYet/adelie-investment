Implement the following plan:

# dashboard.adelie-invest.com — 수정 계획

## Context

진단을 통해 확인된 실제 문제들:

### 문제 1 (Critical): Cloudflare Tunnel 오설정 → ImportError 근본 원인
```yaml
# 현재 /etc/cloudflared/config.yml (deploy-test)
- hostname: dashboard.adelie-invest.com
  service: http://10.10.10.10:8501    # ← infra-server! deploy-test가 아님
```
- `dashboard.adelie-invest.com`이 deploy-test(10.10.10.20)의 `adelie-dashboard`가 아닌
  **infra-server(10.10.10.10)의 포트 8501**로 라우팅됨
- infra-server의 dashboard 이미지는 구버전이라 `inject_custom_css`가 없는 `ui_components.py` 탑재
- 사용자가 보는 ImportError가 바로 여기서 발생:
  ```
  ImportError: cannot import name 'inject_custom_css' from 'utils.ui_components' (/app/utils/ui_components.py)
  ```
- deploy-test에는 이미 최신 코드가 올라가 있고 수동 import 테스트 통과 → **Cloudflare만 고치면 해결**

### 문제 2 (Critical): `_stcore` 404 (Streamlit 멀티페이지)
```
GET /feedback/_stcore/host-config 404
GET /feedback/_stcore/health 404
```
- `st.navigation()`으로 `/feedback` 페이지 이동 시 브라우저 URL이 `/feedback`으로 변경
- Streamlit JS가 현재 URL 기준으로 `_stcore` 요청 → `/feedback/_stcore/...` (실제 경로: `/_stcore/...`)
- nginx reverse proxy 없이 Streamlit 직접 노출 시 이 경로를 처리 불가
- **해결책**: 기존 monitoring 스택에 nginx 서비스 1개 추가 (nginx:alpine, 별도 Dockerfile 불필요)

### 문제 3 (Warning): sidebar color
```
Invalid color passed for widgetBackgroundColor in theme.sidebar: ""
```
- `config.toml`에 `[theme.sidebar]` 섹션 없어서 빈 값 읽음

### monitoring.adelie-invest.com 상태 (문제 없음)
```yaml
# /etc/cloudflared/config.yml
- hostname: monitoring.adelie-invest.com
  service: http://localhost:3000    # ← deploy-test Grafana (정상)
```
- Grafana는 deploy-test의 monitoring compose 포트 3000 → **설정 올바름, 변경 불필요**
- 단, 참조 문서(CLAUDE.md, infra-ops.md)가 dashboard.의 실제 라우팅을 잘못 기술 → **문서만 업데이트**

---

## 수정 계획

> **설계 원칙**: infra-server에 손대지 않음. deploy-test의 기존 monitoring 스택(prometheus/grafana/cadvisor 운영 중)에 nginx 서비스 1개만 추가하여 최소 변경으로 해결.

### Fix 0: Cloudflare Tunnel 오설정 수정 (서버 직접 수정)

`/etc/cloudflared/config.yml` 변경 (deploy-test에서 직접):
```yaml
# 변경 전
- hostname: dashboard.adelie-invest.com
  service: http://10.10.10.10:8501

# 변경 후
- hostname: dashboard.adelie-invest.com
  service: http://localhost:8501      # deploy-test의 nginx (아래에서 추가)
```
변경 후 `systemctl restart cloudflared` 또는 `systemctl reload cloudflared`.

### Fix 1: nginx 컨테이너 추가 (monitoring compose)

nginx가 외부 포트 8501을 담당하고 `_stcore` 경로를 재작성.

#### 파일 1: `infra/monitoring/nginx-dashboard.conf` (신규 생성)
```nginx
server {
    listen 80;

    # /pagename/_stcore/* → /_stcore/*
    # Streamlit st.navigation() 멀티페이지 앱의 sub-page URL에서 발생하는 경로 수정
    location ~ ^/[^/]+/(_stcore/.*)$ {
        proxy_pass http://dashboard:8501/$1;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Streamlit WebSocket + 일반 요청
    location / {
        proxy_pass http://dashboard:8501;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}
```

#### 파일 2: `infra/monitoring/docker-compose.yml` 수정

dashboard의 `ports` → `expose` 변경, nginx 서비스 추가:

```yaml
  # nginx 추가 (dashboard 앞단 프록시)
  nginx:
    image: nginx:alpine
    container_name: adelie-dashboard-nginx
    restart: unless-stopped
    ports:
      - "8501:80"          # 외부 8501 → nginx 80
    volumes:
      - ./nginx-dashboard.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - dashboard
    networks:
      - default

  dashboard:
    # ports: ["8501:8501"]  ← 제거
    expose:
      - "8501"             # 내부 네트워크만 접근
    # 나머지 설정 유지 (volumes, environment, networks 등)
```

**변경 후 흐름:**
```
Cloudflare Tunnel → localhost:8501 → nginx:80 → dashboard:8501 (내부)
                                         ↓ 경로 재작성
                          /feedback/_stcore/* → /_stcore/*
```

### Fix 2: sidebar color warning 해결

#### 파일 3: `infra/docker-dashboard/.streamlit/config.toml` 수정

현재 파일에 `[theme.sidebar]` 섹션 추가:
```toml
[server]
port = 8501
headless = true
runOnSave = false

[browser]
gatherUsageStats = false

[theme]
primaryColor = "#FF6B00"
backgroundColor = "#FFFFFF"
secondaryBackgroundColor = "#F8F9FA"
textColor = "#1A1A2E"
font = "sans serif"

[theme.sidebar]
backgroundColor = "#F8F9FA"
secondaryBackgroundColor = "#FFFFFF"
textColor = "#1A1A2E"
```

---

## 수정 대상 파일

| 파일 | 변경 | 방식 |
|------|------|------|
| `infra/monitoring/nginx-dashboard.conf` | 신규 생성 | 로컬 → git → deploy-test |
| `infra/monitoring/docker-compose.yml` | dashboard ports→expose, nginx 추가 | 로컬 → git → deploy-test |
| `infra/docker-dashboard/.streamlit/config.toml` | `[theme.sidebar]` 추가 | 로컬 → git → deploy-test (이미지 재빌드) |
| deploy-test `/etc/cloudflared/config.yml` | `10.10.10.10:8501` → `localhost:8501` | 서버 직접 수정 (git 관리 밖) |
| `CLAUDE.md` | 서비스 URL 표 정확도 업데이트 | 로컬 → git |
| `memory/infra-ops.md` | Cloudflare Tunnel 라우팅 정보 추가 | 로컬 → git |

---

## 배포 절차

```bash
# 1. 로컬에서 코드 수정 후 develop 브랜치에 커밋 + push

# 2. deploy-test에서 파일 적용 + 재빌드
ssh deploy-test 'cd ~/adelie-investment && \
  git fetch origin && \
  git checkout origin/develop -- \
    infra/monitoring/docker-compose.yml \
    infra/monitoring/nginx-dashboard.conf \
    infra/docker-dashboard/.streamlit/config.toml && \
  git -c user.name="dorae222" -c user.email="dhj9842@gmail.com" \
    commit -m "fix(dashboard): nginx 프록시 추가 + config.toml 수정" \
    infra/monitoring/ infra/docker-dashboard/.streamlit/ && \
  cd infra/monitoring && docker compose up -d --build'

# 3. Cloudflare Tunnel config 수정 + reload (기존 tunnel 연결 유지)
ssh deploy-test 'sudo sed -i \
  "s|service: http://10.10.10.10:8501|service: http://localhost:8501|" \
  /etc/cloudflared/config.yml && \
  grep "dashboard.adelie" /etc/cloudflared/config.yml && \
  sudo systemctl reload cloudflared'
```

## 검증

```bash
# 1. 컨테이너 상태 (nginx + dashboard 모두 Running)
ssh deploy-test 'docker ps | grep -E "adelie-dashboard|adelie-dashboard-nginx"'

# 2. nginx → Streamlit 헬스체크 (200 기대)
ssh deploy-test 'curl -s -o /dev/null -w "%{http_code}" http://localhost:8501/_stcore/health'

# 3. _stcore 경로 재작성 검증 (200 기대)
curl -s -o /dev/null -w "%{http_code}" https://dashboard.adelie-invest.com/_stcore/health
curl -s -o /dev/null -w "%{http_code}" https://dashboard.adelie-invest.com/feedback/_stcore/health

# 4. Cloudflare Tunnel 설정 확인 (localhost:8501 이어야 함)
ssh deploy-test 'grep -A2 "dashboard.adelie" /etc/cloudflared/config.yml'

# 5. monitoring.adelie-invest.com (Grafana) 정상 확인 — 변경 없음
ssh deploy-test 'grep -A2 "monitoring.adelie" /etc/cloudflared/config.yml'
# 기대값: service: http://localhost:3000
```

브라우저:
- `dashboard.adelie-invest.com` → DB 뷰어 로드 (ImportError 없음)
- `dashboard.adelie-invest.com` → 피드백 탭 클릭 → `_stcore` 404 없음
- `monitoring.adelie-invest.com` → Grafana 정상

---

### Fix 3: 문서 업데이트

#### `CLAUDE.md` 서비스 URL 표
현재 기술이 맞지만, 실제 라우팅 흐름을 주석으로 명확화:
```markdown
| https://dashboard.adelie-invest.com | Streamlit 대시보드 | deploy-test:8501 (nginx→Streamlit) |
```
→ Cloudflare Tunnel이 `localhost:8501`(nginx)로 라우팅 후 nginx가 `dashboard:8501`(Streamlit)로 프록시하는 구조임을 명시.

#### `memory/infra-ops.md` Cloudflare Tunnel 섹션 추가
서비스 URL 표 아래에 Cloudflare Tunnel 구성 정보 추가:
```
Cloudflare Tunnel (deploy-test /etc/cloudflared/config.yml):
  demo.adelie-invest.com       → http://localhost:80   (frontend nginx)
  monitoring.adelie-invest.com → http://localhost:3000 (Grafana)
  dashboard.adelie-invest.com  → http://localhost:8501 (nginx proxy → Streamlit)
```
대시보드 배포 명령도 nginx 재시작 포함하도록 업데이트.

---

## 주의사항
- Cloudflare Tunnel config (`/etc/cloudflared/config.yml`)은 git 관리 밖 → 서버 직접 수정
- `systemctl reload cloudflared`: 설정 재로드, 기존 Tunnel 연결은 유지됨
- nginx가 외부 포트 8501을 담당 → Streamlit은 `expose`(내부 네트워크만)로 전환
- dashboard 이미지 재빌드 필수 (`config.toml`이 이미지 내 COPY됨)
- infra-server(10.10.10.10)는 수정하지 않음 — Cloudflare 변경으로 트래픽이 끊기면 자연 해결
- 기존 grafana(3000), prometheus(9090), cadvisor(8080) 서비스 무영향


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /home/hj/.REDACTED.jsonl

---

<task-notification>
<task-id>b17c322</task-id>
<tool-use-id>REDACTED</tool-use-id>
<output-file>/tmp/claude-1000/-home-hj-2026-project-adelie-investment/tasks/b17c322.output</output-file>
<status>completed</status>
<summary>Background command "cloudflared restart" completed (exit code 0)</summary>
</task-notification>
Read the output file to retrieve the result: /tmp/claude-1000/-home-hj-2026-project-adelie-investment/tasks/b17c322.output