# ============================================================
# Adelie Investment - 테스트 환경 (격리된 DB)
# 사용법: docker compose -f docker-compose.test.yml up --abort-on-container-exit
# ============================================================

services:
  # --- 테스트용 격리 DB ---
  postgres-test:
    image: pgvector/pgvector:pg16
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: test_narrative
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d test_narrative"]
      interval: 5s
      timeout: 3s
      retries: 5

  redis-test:
    image: redis:7-alpine
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      retries: 3

  # --- Backend 테스트 ---
  test-backend:
    build: ./backend_api
    command: >
      sh -c "pip install pytest pytest-asyncio httpx -q &&
             pytest tests/ -v --tb=short --junitxml=/app/test-results/backend.xml"
    environment:
      DATABASE_URL: postgresql+asyncpg://test:test@postgres-test:5432/test_narrative
      REDIS_URL: redis://redis-test:6379/0
      OPENAI_API_KEY: ${OPENAI_API_KEY:-test}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-test}
      ENVIRONMENT: test
    volumes:
      - ./test-results:/app/test-results
    depends_on:
      postgres-test:
        condition: service_healthy
      redis-test:
        condition: service_healthy

  # --- E2E 테스트 (Playwright) ---
  test-e2e:
    image: mcr.microsoft.com/playwright:v1.50.0-noble
    command: >
      sh -c "cd /app && npm ci --silent && npx playwright test --reporter=html"
    working_dir: /app
    environment:
      BASE_URL: http://frontend:80
    volumes:
      - ./frontend:/app
      - ./test-results/playwright:/app/playwright-report
    depends_on:
      - frontend
      - backend-api
      - backend-spring
    profiles:
      - e2e

  # --- 앱 서비스 (E2E 테스트 대상) ---
  frontend:
    build: ./frontend
    depends_on:
      - backend-api
      - backend-spring
    profiles:
      - e2e

  backend-api:
    build: ./backend_api
    environment:
      DATABASE_URL: postgresql+asyncpg://test:test@postgres-test:5432/test_narrative
      REDIS_URL: redis://redis-test:6379/0
    depends_on:
      postgres-test:
        condition: service_healthy
    profiles:
      - e2e

  backend-spring:
    build: ./backend-spring
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-test:5432/test_narrative
      SPRING_DATASOURCE_USERNAME: test
      SPRING_DATASOURCE_PASSWORD: test
    depends_on:
      postgres-test:
        condition: service_healthy
    profiles:
      - e2e

volumes:
  test-results:
