Implement the following plan:

# ì „ì²´ í˜„í™© ì§„ë‹¨ ë° ê°œì„  ì„¤ê³„ (2026-02-21)

## Context

1. ì „ìˆ˜ ì¡°ì‚¬ ê²°ê³¼ë¥¼ ë¬¸ì„œì— ë°˜ì˜
2. ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì§„ë‹¨ + ìŠ¤ì¼€ì¤„ëŸ¬ ê°•í™” (ì˜¤ëŠ˜ ìˆ˜ë™ íŠ¸ë¦¬ê±° + ë§¤ì¼ 09:00 KST ìë™ ì‹¤í–‰)
3. íœ´ì¥ì¼ ì²˜ë¦¬ í˜„í™© ê²€ì¦
4. íŒ€ì› ê°œë°œìš© staging ì„œë²„ LXD ë³µì œ ì„¤ê³„
5. Docker ì´ë¯¸ì§€Â·requirements ì •ë¦¬ + ê´€ì¸¡ì„± ê°•í™”

ìê²©ì¦ëª…ì€ ê¸°ì¡´ ì„¤ì •ê°’ ìœ ì§€. CI/CD ìë™í™” ì œì™¸.

---

## í˜„í™© ìš”ì•½ (2026-02-21)

### ì„œë²„

| ì„œë²„ | IP | ì—­í•  | ì£¼ìš” ì»¨í…Œì´ë„ˆ |
|------|-----|------|------------|
| deploy-test | 10.10.10.20 | í”„ë¡œë•ì…˜ í’€ìŠ¤íƒ | frontend, backend-api, postgres, redis, minio, grafana, prometheus, dashboard |
| infra-server | 10.10.10.10 | ê³µìœ  dev DB + ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸ | tmp-postgres-1, tmp-redis-1, cadvisor, node_exporter |
| dev-yj99son | 10.10.10.14 | í”„ë¡ íŠ¸ì—”ë“œ | adelie-news-*, adelie-investment-* |
| dev-jjjh02 | 10.10.10.12 | ë°±ì—”ë“œ | adelie-investment-* |
| dev-hj | 10.10.10.15 | ì¸í”„ë¼ | adelie-investment-* |
| dev-j2hoon10 | 10.10.10.11 | AI/ì±—ë´‡ | ì—†ìŒ |
| dev-ryejinn | 10.10.10.13 | QA | ì—†ìŒ |
| localstack | 10.10.10.16 | AWS LocalStack | â€” |
| staging (ì‹ ê·œ) | 10.10.10.21 | íŒ€ì› ê³µìœ  ìŠ¤í…Œì´ì§• | ì„¤ê³„ â†’ êµ¬í˜„ |

**ë””ìŠ¤í¬ ê³µí†µ:** 83% (1.4T/1.8T) â€” êµ¬ ì´ë¯¸ì§€ ì •ë¦¬ í•„ìš”

### ë°ì´í„° íŒŒì´í”„ë¼ì¸ í˜„í™©

| ë‚ ì§œ | ë¸Œë¦¬í•‘ ìˆ˜ | ìƒíƒœ |
|------|---------|------|
| 2026-02-18 | 1 | âœ… |
| 2026-02-19 | 0 | âŒ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨ |
| 2026-02-20 | 0 | âŒ postgres ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘(14:00 KST) ì´ì „ì— íŒŒì´í”„ë¼ì¸(09:00 KST) ì‹œë„ â†’ DB ì—°ê²° ì‹¤íŒ¨ ì¶”ì • |
| 2026-02-21 | 0 | í† ìš”ì¼ â†’ ì •ìƒ ìŠ¤í‚µ âœ… |

**ìŠ¤ì¼€ì¤„ëŸ¬ í˜„í™©:**
- `scheduler.py`: APScheduler, ì›”-ê¸ˆ 09:00 KST / 16:10 KST ì‹¤í–‰ â†’ ì˜¬ë°”ë¦„
- `market_calendar.py`: pykrx `get_nearest_business_day_in_a_week` + ìš”ì¼ fallback â†’ ì˜¬ë°”ë¦„
- `@lru_cache(maxsize=32)` í‚¤ê°€ ë‚ ì§œ ë¬¸ìì—´("YYYYMMDD")ì´ë¯€ë¡œ ë‹¤ì¼ ìºì‹± ì•ˆì „ âœ…
- **ë¬¸ì œ**: íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ ì—†ìŒ, ì¬ì‹œë„ ì—†ìŒ, ìˆ˜ë™ íŠ¸ë¦¬ê±° ë¶ˆê°€

---

## ê°œì„  í•­ëª©

---

### ğŸ”´ A. ì˜¤ëŠ˜ ë°ì´í„° ìˆ˜ë™ íŠ¸ë¦¬ê±° + 2/19~20 ë°ì´í„° ë³´ì¶©

#### A-1. pipeline routeì— ì „ì²´ LangGraph íŒŒì´í”„ë¼ì¸ íŠ¸ë¦¬ê±° ì¶”ê°€

**í˜„í™©:** `GET/POST /api/v1/pipeline/trigger`ëŠ” ë ˆê±°ì‹œ stock/report collectorë§Œ ì‹¤í–‰.
LangGraph íŒŒì´í”„ë¼ì¸(`datapipeline.run`) ìˆ˜ë™ íŠ¸ë¦¬ê±° ì—”ë“œí¬ì¸íŠ¸ ì—†ìŒ.

**ìˆ˜ì • íŒŒì¼:** `fastapi/app/api/routes/pipeline.py`

```python
# ê¸°ì¡´ ì½”ë“œì— ì•„ë˜ ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
@router.post("/run", summary="LangGraph íŒŒì´í”„ë¼ì¸ ìˆ˜ë™ ì‹¤í–‰")
async def run_full_pipeline(
    background_tasks: BackgroundTasks,
    force: bool = Query(False, description="íœ´ì¥ì¼ì´ì–´ë„ ê°•ì œ ì‹¤í–‰"),
    current_user: dict = Depends(get_current_user),  # ì¸ì¦ í•„ìˆ˜
):
    """
    ë°ì´í„° ìˆ˜ì§‘ + ë‚´ëŸ¬í‹°ë¸Œ ìƒì„± ì „ì²´ íŒŒì´í”„ë¼ì¸ì„ ë°±ê·¸ë¼ìš´ë“œë¡œ ì‹¤í–‰í•œë‹¤.
    - ì˜ì—…ì¼ ì²´í¬ í›„ ì‹¤í–‰ (force=trueë©´ ìŠ¤í‚µ)
    - ìŠ¤ì¼€ì¤„ëŸ¬ì™€ ë™ì¼í•œ _run_datapipeline_subprocess() í˜¸ì¶œ
    """
    from app.core.scheduler import run_morning_pipeline, _run_datapipeline_subprocess
    from app.services.market_calendar import is_kr_market_open_today

    if not force:
        is_trading = await is_kr_market_open_today()
        if not is_trading:
            return {"status": "skipped", "reason": "íœ´ì¥ì¼ (force=trueë¡œ ê°•ì œ ì‹¤í–‰ ê°€ëŠ¥)"}

    async def _run():
        ok = await _run_datapipeline_subprocess()
        logger.info("ìˆ˜ë™ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ê²°ê³¼: %s", "ì„±ê³µ" if ok else "ì‹¤íŒ¨")

    background_tasks.add_task(_run)
    return {"status": "started", "message": "íŒŒì´í”„ë¼ì¸ì„ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘"}
```

**ì§€ê¸ˆ ì‹¤í–‰í•´ì„œ ê¸ˆìš”ì¼ ë°ì´í„° ë³´ì¶©:**
```bash
# deploy-testì—ì„œ ì§ì ‘ ì‹¤í–‰ (í† ìš”ì¼ì´ë¯€ë¡œ force=true í•„ìš”)
ssh deploy-test "docker exec adelie-backend-api sh -c '
  cd /app && python -m datapipeline.run --backend live --market KR --topic-count 3
'"
```

#### A-2. íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨ ì‹œ Discord ì•Œë¦¼ ì¶”ê°€

**ìˆ˜ì • íŒŒì¼:** `fastapi/app/core/scheduler.py`

```python
# ì„¤ì •ì—ì„œ Discord webhook ì½ê¸°
DISCORD_WEBHOOK = os.getenv("DISCORD_PIPELINE_WEBHOOK", "")

async def _notify_discord(title: str, message: str, color: int = 15158332):
    """Discord webhookìœ¼ë¡œ ì•Œë¦¼ ì „ì†¡."""
    if not DISCORD_WEBHOOK:
        return
    import httpx
    payload = {
        "embeds": [{
            "title": title,
            "description": message,
            "color": color,  # ë¹¨ê°•=ì‹¤íŒ¨, ì´ˆë¡=ì„±ê³µ
        }]
    }
    try:
        async with httpx.AsyncClient(timeout=10) as client:
            await client.post(DISCORD_WEBHOOK, json=payload)
    except Exception as e:
        logger.warning("Discord ì•Œë¦¼ ì‹¤íŒ¨: %s", e)


async def run_morning_pipeline():
    """ëª¨ë‹ íŒŒì´í”„ë¼ì¸: KST 09:00, ì˜ì—…ì¼ë§Œ ì‹¤í–‰."""
    if not await _is_trading_day():
        logger.info("=== ëª¨ë‹ íŒŒì´í”„ë¼ì¸ ìŠ¤í‚µ (íœ´ì¥ì¼) ===")
        return

    logger.info("=== ëª¨ë‹ íŒŒì´í”„ë¼ì¸ ì‹œì‘ ===")
    ok = await _run_datapipeline_subprocess()

    if ok:
        await _post_pipeline_hooks()
        # ì„±ê³µ ì•Œë¦¼ (ì„ íƒ â€” ë§¤ì¼ ì•Œë¦¼ì´ ë¶€ë‹´ìŠ¤ëŸ¬ìš°ë©´ ì œê±°)
        from datetime import datetime
        kst = timezone(timedelta(hours=9))
        today = datetime.now(kst).strftime("%Y-%m-%d")
        await _notify_discord(
            f"âœ… ëª¨ë‹ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ({today})",
            "ì˜¤ëŠ˜ì˜ ë¸Œë¦¬í•‘ ë°ì´í„°ê°€ ìƒì„±ëìŠµë‹ˆë‹¤.",
            color=3066993  # ì´ˆë¡
        )
    else:
        logger.error("ëª¨ë‹ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨")
        await _notify_discord(
            "âŒ ëª¨ë‹ íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨",
            f"ë‚ ì§œ: {datetime.now(KST).strftime('%Y-%m-%d %H:%M KST')}\n"
            "ìˆ˜ë™ ì‹¤í–‰: `POST /api/v1/pipeline/run?force=true`",
            color=15158332  # ë¹¨ê°•
        )
    logger.info("=== ëª¨ë‹ íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ===")
```

**.envì— ì¶”ê°€ (íŒ€ Discord webhook):**
```
DISCORD_PIPELINE_WEBHOOK=https://discord.com/api/webhooks/...
```

#### A-3. íŒŒì´í”„ë¼ì¸ íƒ€ì„ì•„ì›ƒ 60ë¶„ìœ¼ë¡œ ì¦ê°€

**í˜„ì¬:** `timeout=1800` (30ë¶„) â€” LLM í˜¸ì¶œ 3ê°œ í† í”½ Ã— ì—¬ëŸ¬ ë…¸ë“œë©´ ë¶€ì¡±í•  ìˆ˜ ìˆìŒ

**ìˆ˜ì •:** `fastapi/app/core/scheduler.py:_run_datapipeline_subprocess()`
```python
stdout, stderr = await asyncio.wait_for(proc.communicate(), timeout=3600)  # 30ë¶„ â†’ 60ë¶„
```

---

### ğŸ”´ B. íœ´ì¥ì¼ ì²˜ë¦¬ í˜„í™© ê²€ì¦ + ê°œì„ 

#### B-1. í˜„ì¬ êµ¬í˜„ ê²€ì¦

```
market_calendar.py:
  _check_business_day(date_str) â†’ pykrx.get_nearest_business_day_in_a_week()
  - ê²°ê³¼ê°€ todayì™€ ê°™ìœ¼ë©´ ì˜ì—…ì¼
  - @lru_cache(maxsize=32) â€” ë‚ ì§œë³„ ìºì‹±, ì•ˆì „ âœ…
  - fallback: ì£¼ë§ì´ë©´ ë¹„ì˜ì—…ì¼ (ê³µíœ´ì¼ì€ pykrxê°€ ì²˜ë¦¬)
```

**í…ŒìŠ¤íŠ¸ í™•ì¸:**
```bash
# pykrx ê³µíœ´ì¼ ì²˜ë¦¬ ê²€ì¦
.venv/bin/python -c "
from pykrx.stock import get_nearest_business_day_in_a_week
# ì„¤ë‚  í…ŒìŠ¤íŠ¸ (ì˜ˆ: 2026-01-28 ~ 2026-01-30)
for d in ['20260128', '20260129', '20260130', '20260131', '20260201']:
    nearest = get_nearest_business_day_in_a_week(d)
    print(f'{d}: nearest={nearest}, is_trading={nearest==d}')
"
```

#### B-2. ë°œê²¬ëœ ì ì¬ì  ë¬¸ì œ: pykrx ë„¤íŠ¸ì›Œí¬ ì˜ì¡´

`pykrx.get_nearest_business_day_in_a_week`ëŠ” KRX ë°ì´í„°ë¥¼ ë„¤íŠ¸ì›Œí¬ë¡œ ì¡°íšŒí•¨.
ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨ ì‹œ fallback(ì£¼ë§ íŒë‹¨)ìœ¼ë¡œ ì²˜ë¦¬í•˜ì§€ë§Œ, ê³µíœ´ì¼ íŒë‹¨ì€ ì‹¤íŒ¨í•¨.

**ê°œì„  ì„¤ê³„:** `@lru_cache`ì˜ `maxsize=32` â†’ 32ì¼ì¹˜ ìºì‹œ ìœ ì§€.
ì¶”ê°€ë¡œ `functools.lru_cache` ëŒ€ì‹  `cachetools.TTLCache(maxsize=365, ttl=86400)`ìœ¼ë¡œ ì¼ ë‹¨ìœ„ TTL ì„¤ì •:

```python
# ìˆ˜ì • ì „: @lru_cache(maxsize=32)
# ìˆ˜ì • í›„:
from cachetools import TTLCache, cached
_business_day_cache = TTLCache(maxsize=365, ttl=86400)

@cached(_business_day_cache)
def _check_business_day(date_str: str) -> bool:
    ...
```

`cachetools` ì¶”ê°€: `fastapi/requirements.txt`ì— `cachetools>=5.0.0`

#### B-3. íŒŒì´í”„ë¼ì¸ ìŠ¤ì¼€ì¤„ëŸ¬ ìŠ¤í‚µ ë¡œê·¸ ê°•í™”

í˜„ì¬: `logger.info("=== ëª¨ë‹ íŒŒì´í”„ë¼ì¸ ìŠ¤í‚µ (íœ´ì¥ì¼) ===")`
â†’ ì–´ë–¤ ë‚ ì§œì¸ì§€, pykrx ë°˜í™˜ê°’ì´ ë¬´ì—‡ì¸ì§€ ì•Œ ìˆ˜ ì—†ìŒ

```python
async def _is_trading_day() -> bool:
    from datetime import datetime
    kst = timezone(timedelta(hours=9))
    today_str = datetime.now(kst).strftime("%Y%m%d")
    try:
        from app.services.market_calendar import is_kr_market_open_today
        result = await is_kr_market_open_today()
        logger.info("ì˜ì—…ì¼ ì²´í¬: %s â†’ %s", today_str, "ì˜ì—…ì¼" if result else "íœ´ì¥ì¼")
        return result
    except Exception as e:
        logger.warning("ì˜ì—…ì¼ í™•ì¸ ì‹¤íŒ¨ (ì‹¤í–‰ ì§„í–‰): %s", e)
        return True
```

---

### ğŸ”´ C. íŒ€ì› ê°œë°œìš© Staging ì„œë²„ LXD ë³µì œ

#### C-1. í˜„í™© ë¶„ì„

**íŒ€ì› ê°œë°œ í™˜ê²½ ë¬¸ì œ:**
- dev-yj99son, dev-jjjh02, dev-hj: ê°ì docker-compose.dev.yml ì‹¤í–‰ ì¤‘ (ê³µìœ  infra-server DB ì‚¬ìš©)
- dev-j2hoon10, dev-ryejinn: Docker ì„œë¹„ìŠ¤ ì—†ìŒ (ê°ì ë¡œì»¬ë§Œ ê°œë°œ)
- **ê³µìœ  Staging ë¶€ì¬**: develop ë¸Œëœì¹˜ì˜ ìµœì‹  ìƒíƒœë¥¼ íŒ€ ì „ì²´ê°€ í…ŒìŠ¤íŠ¸í•  ê³µê°„ ì—†ìŒ

**ëª©í‘œ:** `staging` LXD ì»¨í…Œì´ë„ˆ ìƒì„± â†’ develop ë¸Œëœì¹˜ ìµœì‹  ì´ë¯¸ì§€ ìë™ ë°˜ì˜ â†’ URL ì œê³µ

#### C-2. LXD ì»¨í…Œì´ë„ˆ ìƒì„±

```bash
# LXD í˜¸ìŠ¤íŠ¸ì—ì„œ ì‹¤í–‰ (hjì˜ ë¡œì»¬ í™˜ê²½)
lxc launch ubuntu:22.04 staging
lxc config set staging limits.memory 16GB
lxc config set staging limits.cpu 4

# ë„¤íŠ¸ì›Œí¬ ì„¤ì • (deploy-testì™€ ê°™ì€ ëŒ€ì—­)
lxc config device set staging eth0 ipv4.address 10.10.10.21

# ê¸°ë³¸ ì„¤ì •
lxc exec staging -- apt-get update -q
lxc exec staging -- apt-get install -y docker.io docker-compose-plugin git curl
lxc exec staging -- systemctl enable docker
lxc exec staging -- systemctl start docker

# ubuntu ì‚¬ìš©ìë¥¼ docker ê·¸ë£¹ì— ì¶”ê°€
lxc exec staging -- usermod -aG docker ubuntu

# SSH í‚¤ ë³µì‚¬ (deploy-testì™€ ë™ì¼í•œ íŒ¨í„´)
lxc exec staging -- bash -c "mkdir -p /home/ubuntu/.ssh && \
  echo '$(cat ~/.ssh/id_ed25519.pub)' >> /home/ubuntu/.ssh/authorized_keys && \
  chown -R ubuntu:ubuntu /home/ubuntu/.ssh"
```

#### C-3. staging ì„œë²„ í”„ë¡œì íŠ¸ ì„¤ì •

```bash
# staging ì„œë²„ì—ì„œ
ssh staging "
git clone https://github.com/404-NFYet/adelie-investment.git ~/adelie-investment
cd ~/adelie-investment
git checkout develop

# .env ë³µì‚¬ (deploy-testì—ì„œ ê°€ì ¸ì˜´, API í‚¤ í¬í•¨)
"

# deploy-test .envë¥¼ stagingìœ¼ë¡œ ë³µì‚¬ (API í‚¤ í¬í•¨)
scp deploy-test:~/adelie-investment/.env staging:~/adelie-investment/.env
```

#### C-4. staging docker-compose ë³„ë„ ì„¤ì •

**ì‹ ê·œ íŒŒì¼:** `docker-compose.staging.yml`

```yaml
# ============================================================
# Adelie Investment - Staging í™˜ê²½
# deploy-test ì„¤ì •ê³¼ ë™ì¼, í¬íŠ¸/ì´ë¦„ ì¼ë¶€ ë³€ê²½
# ============================================================

services:
  postgres:
    image: pgvector/pgvector:pg16
    container_name: staging-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-narative}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-narrative_invest}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-narative}"]
      interval: 10s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: staging-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: staging-minio
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY:-minioadmin123}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data

  backend-api:
    image: ${REGISTRY:-dorae222}/adelie-backend-api:latest
    container_name: staging-backend-api
    restart: unless-stopped
    expose:
      - "8082"
    env_file: .env
    environment:
      TZ: Asia/Seoul
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER:-narative}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-narrative_invest}
      REDIS_URL: redis://redis:6379/1
      REDIS_HOST: redis
      MINIO_ENDPOINT: http://minio:9000
      DEBUG: "false"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    image: ${REGISTRY:-dorae222}/adelie-frontend:latest
    container_name: staging-frontend
    restart: unless-stopped
    ports:
      - "80:80"
    depends_on:
      backend-api:
        condition: service_healthy

volumes:
  postgres_data:
  redis_data:
  minio_data:

networks:
  default:
    name: staging-network
```

#### C-5. staging ì´ˆê¸°í™” + ì‹¤í–‰

```bash
# staging ì„œë²„ì—ì„œ
ssh staging "
cd ~/adelie-investment

# Docker Hubì—ì„œ ìµœì‹  ì´ë¯¸ì§€ pull
docker compose -f docker-compose.staging.yml pull

# ì‹¤í–‰
docker compose -f docker-compose.staging.yml up -d

# DB ë§ˆì´ê·¸ë ˆì´ì…˜
sleep 10
docker exec staging-backend-api sh -c '
  cd /app/database && python -m alembic upgrade head
'

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
docker compose -f docker-compose.staging.yml ps
"
```

#### C-6. Makefileì— staging ë°°í¬ íƒ€ê²Ÿ ì¶”ê°€

`lxd/Makefile`ì— ì¶”ê°€:
```makefile
# --- Staging ë°°í¬ ---
deploy-staging:
	ssh staging 'cd ~/adelie-investment && git pull origin develop && \
		docker compose -f docker-compose.staging.yml pull && \
		docker compose -f docker-compose.staging.yml up -d --remove-orphans'
	@echo "âœ… staging(10.10.10.21) ë°°í¬ ì™„ë£Œ"

# lxd/Makefileì˜ sync-lxd íƒ€ê²Ÿì— staging ì¶”ê°€
sync-lxd: ...
	lxc exec staging -- bash -c "cd /home/ubuntu/adelie-investment && git pull origin develop"
```

#### C-7. Prometheus ëª¨ë‹ˆí„°ë§ì— staging ì¶”ê°€

`infra/monitoring/prometheus.yml` ìˆ˜ì •:
```yaml
scrape_configs:
  - job_name: 'node'
    static_configs:
      - targets:
          - '10.10.10.10:9100'   # infra-server
          - '10.10.10.20:9100'   # deploy-test
          - '10.10.10.21:9100'   # staging (ì‹ ê·œ)
          # dev ì„œë²„ë“¤ ìœ ì§€
```

---

### ğŸŸ  D. Docker ì´ë¯¸ì§€ ìµœì í™”

#### D-1. ì˜¤ë˜ëœ ì´ë¯¸ì§€/ë¸Œëœì¹˜ ì •ë¦¬

```bash
# --- ë¡œì»¬ ì •ë¦¬ ---
# spring ì´ë¯¸ì§€ ì‚­ì œ (ì´ ~2GB)
docker rmi \
  dorae222/adelie-backend-spring:latest \
  dorae222/adelie-backend-spring:20260210-v6 \
  dorae222/adelie-backend-spring:20260210-v7 \
  dorae222/adelie-backend-spring:rollback-0210-0900

# êµ¬ ë‚ ì§œ íƒœê·¸ ì‚­ì œ (~15GB)
docker images | grep -E "dorae222.*(20260209|20260210)" | \
  awk '{print $1":"$2}' | xargs docker rmi 2>/dev/null || true

# deploy-test ì •ë¦¬
ssh deploy-test 'docker image prune -a --filter "until=168h" -f'
```

**ì˜¤ë˜ëœ git ë¸Œëœì¹˜ ì •ë¦¬ (origin):**
```bash
git push origin --delete \
  chore/agent-config \
  chore/pipeline-prompt-content-sync-interface \
  chore/pipeline-sync-interface-9715036-core \
  chore/pipeline-sync-interface-9715036-local-compat \
  chore/sync-backend-e2e-to-dev-backend \
  chore/sync-frontend-e2e-to-dev-frontend \
  chore/sync-pipeline-e2e-to-dev-pipeline \
  dev/backend-tutor-user-sessions \
  dev/frontend-ui-v1 \
  dev/news \
  feat/keywords-icon-mapping-stabilization
```

#### D-2. .dockerignore ì‹ ê·œ ìƒì„±

íŒŒì¼: `/home/hj/2026/project/adelie-investment/.dockerignore`
```
**/__pycache__
**/*.pyc
**/*.pyo
**/.pytest_cache
.venv/
venv/
tests/
.git/
.github/
lxd/
*.egg-info/
.ruff_cache/
.env*
!.env.example
frontend/node_modules/
frontend/dist/
infra/
*.log
.DS_Store
```

#### D-3. fastapi/requirements.txt ì •ë¦¬

**ì œê±° (dev/datapipeline ì „ìš©):**
```
# ì œê±°
python-jose[cryptography]==3.3.0   # PyJWTì™€ ì¤‘ë³µ
bcrypt<4.0                          # passlib[bcrypt]ë¡œ ì¶©ë¶„
pykrx>=1.0.0                        # datapipeline ì „ìš©
psycopg2-binary>=2.9.0             # sync driver ë¯¸ì‚¬ìš© (asyncpgë§Œ ì‚¬ìš©)
finance-datareader>=0.9.0           # datapipeline ì „ìš©
feedparser>=6.0.0                   # datapipeline ì „ìš©
pytest>=8.0.0                       # dev ì „ìš© â†’ requirements-dev.txtë¡œ ì´ë™
pytest-asyncio>=0.24.0              # dev ì „ìš© â†’ requirements-dev.txtë¡œ ì´ë™
```

**ì‹ ê·œ `fastapi/requirements-dev.txt`:**
```
pytest>=8.0.0
pytest-asyncio>=0.24.0
httpx>=0.27.0
```

**ì¶”ê°€:**
```
cachetools>=5.0.0   # TTLCache for market_calendar.py
```

#### D-4. multi-stage Dockerfile

íŒŒì¼: `fastapi/Dockerfile`
```dockerfile
# ============================================================
# Adelie Investment - FastAPI Backend (Multi-stage)
# ============================================================
FROM python:3.11-slim AS builder
WORKDIR /build
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc libpq-dev && \
    rm -rf /var/lib/apt/lists/*
COPY fastapi/requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# --- ëŸ°íƒ€ì„ ---
FROM python:3.11-slim
WORKDIR /app
RUN apt-get update && \
    apt-get install -y --no-install-recommends libpq5 curl && \
    rm -rf /var/lib/apt/lists/*
COPY --from=builder /root/.local /root/.local
ENV PATH=/root/.local/bin:$PATH \
    PYTHONPATH=/app

COPY fastapi/ ./
COPY shared/ ./shared/
COPY chatbot/ ./chatbot/
COPY datapipeline/ ./datapipeline/
COPY database/alembic/ ./database/alembic/
COPY database/alembic.ini ./database/
RUN ln -sf /app/datapipeline/scripts /app/scripts && \
    ln -sf /app/datapipeline/collectors /app/collectors

HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
    CMD curl -f http://localhost:8082/api/v1/health || exit 1
EXPOSE 8082
CMD ["sh", "-c", "uvicorn app.main:app --host 0.0.0.0 --port 8082 --workers ${WEB_CONCURRENCY:-4}"]
```

---

### ğŸŸ  E. ê´€ì¸¡ì„± ê°•í™”

#### E-1. Prometheus AlertManager

**ì‹ ê·œ íŒŒì¼:** `infra/monitoring/alertmanager.yml`
```yaml
global:
  resolve_timeout: 5m

route:
  receiver: discord
  group_wait: 30s
  repeat_interval: 12h

receivers:
  - name: discord
    discord_configs:
      - webhook_url: ${DISCORD_WEBHOOK_URL}
        title: "[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }}"
        message: "{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}"
```

**ì‹ ê·œ íŒŒì¼:** `infra/monitoring/rules/adelie-alerts.yml`
```yaml
groups:
  - name: service
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 2m
        labels: {severity: critical}
        annotations:
          summary: "ì„œë¹„ìŠ¤ ë‹¤ìš´: {{ $labels.job }} @ {{ $labels.instance }}"

      - alert: DiskSpaceWarning
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 5m
        labels: {severity: warning}
        annotations:
          summary: "ë””ìŠ¤í¬ 15% ë¯¸ë§Œ: {{ $labels.instance }}"

      - alert: HighErrorRate
        expr: rate(http_requests_total{job="fastapi",status=~"5.."}[5m]) / rate(http_requests_total{job="fastapi"}[5m]) > 0.05
        for: 2m
        labels: {severity: warning}
        annotations:
          summary: "FastAPI ì—ëŸ¬ìœ¨ 5% ì´ˆê³¼"
```

**`infra/monitoring/prometheus.yml` ìˆ˜ì •:**
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s   # ì¶”ê°€

alerting:                      # ì¶”ê°€
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

rule_files:                    # ì¶”ê°€
  - /etc/prometheus/rules/*.yml

scrape_configs:
  # (ê¸°ì¡´ ë‚´ìš© ìœ ì§€)
  - job_name: 'node'
    static_configs:
      - targets:
          - '10.10.10.10:9100'
          - '10.10.10.20:9100'
          - '10.10.10.21:9100'   # staging ì¶”ê°€
          # ... ë‚˜ë¨¸ì§€ ìœ ì§€
```

**`infra/monitoring/docker-compose.yml` ìˆ˜ì • â€” alertmanager ì„œë¹„ìŠ¤ ì¶”ê°€:**
```yaml
  alertmanager:
    image: prom/alertmanager:latest
    container_name: adelie-alertmanager
    restart: unless-stopped
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager_data:/alertmanager
    command:
      - --config.file=/etc/alertmanager/alertmanager.yml
      - --storage.path=/alertmanager

volumes:
  # ê¸°ì¡´ prometheus_data, grafana_dataì— ì¶”ê°€
  alertmanager_data:
```

#### E-2. Grafana ëŒ€ì‹œë³´ë“œ í”„ë¡œë¹„ì €ë‹

**`infra/monitoring/grafana/provisioning/dashboards/dashboards.yml`:**
```yaml
apiVersion: 1
providers:
  - name: Adelie Dashboards
    folder: Adelie
    type: file
    options:
      path: /etc/grafana/provisioning/dashboards/json
```

**í‘œì¤€ ëŒ€ì‹œë³´ë“œ ë‹¤ìš´ë¡œë“œ ìŠ¤í¬ë¦½íŠ¸ (1íšŒì„±):**
```bash
mkdir -p infra/monitoring/grafana/provisioning/dashboards/json
# Node Exporter Full (ID: 1860)
curl -sL "https://grafana.com/api/dashboards/1860/revisions/latest/download" \
  | python3 -c "import json,sys; d=json.load(sys.stdin); d['title']='Node Exporter Full'; print(json.dumps(d))" \
  > infra/monitoring/grafana/provisioning/dashboards/json/node-exporter-full.json
```

---

### ğŸŸ¢ F. ë¬¸ì„œ ì—…ë°ì´íŠ¸

#### CLAUDE.md ì¶”ê°€ ì„¹ì…˜

```markdown
## ì¸í”„ë¼ ì„œë²„ ì—­í•  (2026-02-21 ê¸°ì¤€)

### ì„œë²„ë³„ ì—­í• 

| ì„œë²„ | IP | ì—­í•  | ì ‘ì† |
|------|----|------|------|
| deploy-test | 10.10.10.20 | í”„ë¡œë•ì…˜ | ssh deploy-test |
| staging | 10.10.10.21 | íŒ€ ê³µìœ  ìŠ¤í…Œì´ì§• | ssh staging |
| infra-server | 10.10.10.10 | ê³µìœ  dev DB + ëª¨ë‹ˆí„°ë§ ì—ì´ì „íŠ¸ | ssh infra-server |

### staging ì„œë²„ ë°°í¬
```bash
make -f lxd/Makefile deploy-staging  # develop ìµœì‹  â†’ staging ë°°í¬
```

### ì•„í‚¤í…ì²˜ ë…¸íŠ¸ (ì¤‘ìš”)
- `chatbot/agent/tutor_agent.py`: **EXPERIMENTAL** â€” í”„ë¡œë•ì…˜ ë¯¸ì‚¬ìš©
- í”„ë¡œë•ì…˜ íŠœí„°: `fastapi/app/services/tutor_engine.py` (ì§ì ‘ OpenAI í˜¸ì¶œ)
- `chatbot/tools/visualization_tool.py`ë§Œ í”„ë¡œë•ì…˜ì—ì„œ ì‚¬ìš© (tutor_engine.py ë‚´ë¶€ì„œ import)

### ë°ì´í„° íŒŒì´í”„ë¼ì¸ ìˆ˜ë™ ì‹¤í–‰
```bash
# deploy-testì—ì„œ ì§ì ‘ ì‹¤í–‰ (í† ìš”ì¼/ê³µíœ´ì¼ì— force ì‹¤í–‰ ì‹œ)
docker exec adelie-backend-api python -m datapipeline.run --backend live --market KR --topic-count 3

# API ì—”ë“œí¬ì¸íŠ¸ë¡œ íŠ¸ë¦¬ê±° (ì˜ì—…ì¼ ì²´í¬ í¬í•¨)
curl -X POST https://demo.adelie-invest.com/api/v1/pipeline/run \
  -H "Authorization: Bearer <token>"

# force ëª¨ë“œ (íœ´ì¥ì¼ì—ë„ ì‹¤í–‰)
curl -X POST "https://demo.adelie-invest.com/api/v1/pipeline/run?force=true" \
  -H "Authorization: Bearer <token>"
```
```

#### .env.example ì •ë¦¬

**ì œê±° í•­ëª©:**
```
SPRING_PORT=8083
SPRING_DATASOURCE_URL=jdbc:postgresql://...
SPRING_DATASOURCE_USERNAME=narative
JWT_ACCESS_EXPIRATION=3600000
JWT_REFRESH_EXPIRATION=604800000
NEO4J_URI=bolt://10.10.10.10:7687
NEO4J_USER=neo4j
```

**ìˆ˜ì • í•­ëª©:**
```
# DATABASE_URL: ë¡œì»¬/dev í™˜ê²½ì€ infra-server, í”„ë¡œë•ì…˜ì€ docker-composeê°€ postgresë¡œ ë®ì–´ì”€
REDACTED://narative:password@10.10.10.10:5432/narrative_invest

# Discord Pipeline ì•Œë¦¼ webhook (ì„ íƒ)
DISCORD_PIPELINE_WEBHOOK=

DEBUG=false
```

---

## êµ¬í˜„ ìš°ì„ ìˆœìœ„

```
ì¦‰ì‹œ ì‹¤í–‰ (ì˜¤ëŠ˜):
  [A-ì¦‰ì‹œ] docker execìœ¼ë¡œ íŒŒì´í”„ë¼ì¸ ìˆ˜ë™ ì‹¤í–‰ (2/19~20 ë°ì´í„° ë³´ì¶©)
  [F] CLAUDE.md + .env.example ì—…ë°ì´íŠ¸
  [D-1] êµ¬ Docker ì´ë¯¸ì§€ + ë¸Œëœì¹˜ ì •ë¦¬ (ë””ìŠ¤í¬ í™•ë³´)

ì´ë²ˆ ì£¼ (2/22~28):
  [A-1] pipeline routeì— /run ì—”ë“œí¬ì¸íŠ¸ ì¶”ê°€
  [A-2] íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨ Discord ì•Œë¦¼ ì¶”ê°€
  [A-3] íƒ€ì„ì•„ì›ƒ 60ë¶„ìœ¼ë¡œ ì¦ê°€
  [B-2] cachetools TTLCache ì ìš©
  [B-3] ë¡œê·¸ ê°•í™”
  [C-1~5] staging ì„œë²„ LXD ìƒì„± + ì´ˆê¸°í™”

ë‹¤ìŒ ì£¼:
  [D-2] .dockerignore ìƒì„±
  [D-3] requirements.txt ì •ë¦¬
  [D-4] multi-stage Dockerfile
  [E-1] Prometheus AlertManager
  [E-2] Grafana ëŒ€ì‹œë³´ë“œ í”„ë¡œë¹„ì €ë‹
  [C-6~7] staging Makefile íƒ€ê²Ÿ + Prometheus ì¶”ê°€
```

---

## ê²€ì¦ ë°©ë²•

### A (íŒŒì´í”„ë¼ì¸ ìˆ˜ë™ ì‹¤í–‰)
```bash
# ì‹¤í–‰ í›„ DB í™•ì¸
ssh deploy-test "docker exec adelie-postgres psql -U narative -d narrative_invest -c \
  'SELECT briefing_date, count(*) FROM daily_briefings WHERE briefing_date >= current_date - 7 GROUP BY 1 ORDER BY 1'"
# ì˜¤ëŠ˜ ë‚ ì§œ(ë˜ëŠ” ê°€ì¥ ìµœê·¼ ì˜ì—…ì¼)ì— 1+ í–‰ ìˆì–´ì•¼ í•¨
```

### B (íœ´ì¥ì¼ ì²˜ë¦¬)
```bash
.venv/bin/python -c "
from pykrx.stock import get_nearest_business_day_in_a_week
# ì„¤ë‚  2026 í…ŒìŠ¤íŠ¸
for d in ['20260128', '20260129', '20260201']:
    nearest = get_nearest_business_day_in_a_week(d)
    print(f'{d}: is_trading={nearest==d}')
"
# 20260128, 20260129 â†’ False (ì„¤ë‚ ), 20260201 â†’ True
```

### C (staging ì„œë²„)
```bash
curl http://10.10.10.21/api/v1/health  # 200 OK
curl http://10.10.10.21/api/v1/keywords/today  # ë°ì´í„° ë°˜í™˜
```

### D (Docker ì´ë¯¸ì§€ í¬ê¸°)
```bash
docker build -f fastapi/Dockerfile -t adelie-backend-api:test .
docker images adelie-backend-api:test  # ëª©í‘œ: 600MB ì´í•˜
```

### E (AlertManager)
```bash
# deploy-testì—ì„œ
ssh deploy-test "docker ps | grep alertmanager"  # alertmanager ì‹¤í–‰ ì¤‘
# í…ŒìŠ¤íŠ¸ ê²½ë³´
ssh deploy-test "docker stop adelie-backend-api"
sleep 130
# Discordì— ê²½ë³´ ë©”ì‹œì§€ í™•ì¸
ssh deploy-test "docker start adelie-backend-api"
```


If you need specific details from before exiting plan mode (like exact code snippets, error messages, or content you generated), read the full transcript at: /home/hj/.REDACTED.jsonl

---

<task-notification>
<task-id>abc527f9b8483e51e</task-id>
<tool-use-id>REDACTED</tool-use-id>
<status>completed</status>
<summary>Agent "í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ í’ˆì§ˆ ë° ì•„í‚¤í…ì²˜ ë¶„ì„" completed</summary>
<result>ì´ì œ ì¶©ë¶„í•œ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í–ˆìœ¼ë‹ˆ ì¢…í•© ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

---

## Adelie Investment í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ í’ˆì§ˆ ë¶„ì„ ë³´ê³ ì„œ

### 1. App êµ¬ì¡° ë¶„ì„

#### 1.1 App.jsx - ë¼ìš°í„° ë° Context êµ¬ì¡°

**íŒŒì¼**: `/home/hj/2026/project/adelie-investment/frontend/src/App.jsx`

**ê¸ì •ì  ì¸¡ë©´**:
- âœ… React.lazyë¥¼ í™œìš©í•œ í˜ì´ì§€ ë‹¨ìœ„ ì½”ë“œ ìŠ¤í”Œë¦¬íŒ… ì ìš© (14ê°œ í˜ì´ì§€ ëª¨ë‘)
- âœ… Suspense í´ë°±ìœ¼ë¡œ PageLoader ì»´í¬ë„ŒíŠ¸ ì œê³µ
- âœ… ProtectedRoute ê³ ì°¨ ì»´í¬ë„ŒíŠ¸ë¡œ ì¸ì¦ ë¼ìš°íŠ¸ ê´€ë¦¬
- âœ… Context Provider ëª…í™•í•œ ì¤‘ì²© ìˆœì„œ (Theme > User > Portfolio > Tutor > Term)

**ê°œì„ ì **:
- âš ï¸ **Context Provider ì¤‘ì²©ì´ ê¹ŠìŒ** (6ë‹¨ê³„): ë¦¬ë Œë”ë§ ìµœì í™” ê¸°íšŒ ë¶€ì¡±
  ```jsx
  // í˜„ì¬: 6ë‹¨ê³„ ê¹ŠìŒ
  <ThemeProvider>
    <UserProvider>
      <PortfolioProvider>
        <TutorProvider>
          <TermProvider>
            <ErrorBoundary>
              <ToastProvider>
  ```
  â†’ Provider ë¶„ë¦¬ ë˜ëŠ” Context êµ¬ë… ë²”ìœ„ ì„¸ë¶„í™” í•„ìš”

- âš ï¸ **CaseRedirect ì»´í¬ë„ŒíŠ¸ê°€ ë³„ë„ë¡œ ì¡´ì¬**: 
  ```jsx
  // Line 36-40
  function CaseRedirect() {
    const { caseId } = useParams();
    if (!caseId) return <Navigate to="/search" replace />;
    return <Navigate to={`/narrative/${caseId}`} replace />;
  }
  ```
  â†’ ë‹¨ìˆœ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¡œì§ì´ ì»´í¬ë„ŒíŠ¸ë¡œ ì¶”ìƒí™”ë¨ (ë¶ˆí•„ìš”í•œ ë Œë”ë§)

#### 1.2 í˜ì´ì§€ êµ¬ì¡°

**íŒŒì¼ë“¤**: `/home/hj/2026/project/adelie-investment/frontend/src/pages/`
- 17ê°œ í˜ì´ì§€ íŒŒì¼ ì¡´ì¬
- ëª¨ë‘ default exportë¡œ êµ¬ì„±

**ê°œì„ ì **:
- âš ï¸ **í˜ì´ì§€ë³„ ìƒíƒœ ê´€ë¦¬ ë¶„ì‚°**: ê° í˜ì´ì§€ì—ì„œ ë…ë¦½ì ìœ¼ë¡œ `useState`/`useEffect` ì‚¬ìš©
  ```jsx
  // Home.jsx (Line 17-37)
  const [keywords, setKeywords] = useState([]);
  const [isLoadingKeywords, setIsLoadingKeywords] = useState(true);
  const [keywordError, setKeywordError] = useState(null);

  useEffect(() => {
    const fetchKeywords = async () => { ... };
    fetchKeywords();
  }, []); // ë¹ˆ ì˜ì¡´ì„± ë°°ì—´
  ```
  â†’ ìƒíƒœ ê´€ë¦¬ê°€ ë¶„ì‚°ë˜ì–´ ìˆê³ , ìœ ì‚¬í•œ íŒ¨í„´ì´ ë°˜ë³µë¨ (fetch + loading + error)

---

### 2. ì„±ëŠ¥ ê´€ë ¨ ì´ìŠˆ

#### 2.1 ë²ˆë“¤ í¬ê¸° ë° ì˜ì¡´ì„±

**íŒŒì¼**: `/home/hj/2026/project/adelie-investment/frontend/package.json`

```json
{
  "dependencies": {
    "chart.js": "^4.5.1",           // 15KB
    "echarts": "^6.0.0",             // 600KB+ (ë§¤ìš° í¼!)
    "echarts-for-react": "^3.0.6",
    "framer-motion": "^12.0.0",      // 40KB
    "plotly.js": "^3.3.1",           // 800KB+ (ë§¤ìš° í¼!)
    "plotly.js-basic-dist-min": "^3.3.1",
    "react-markdown": "^10.1.0",
    "react-plotly.js": "^2.6.0",
    "katex": "^0.16.11",
    "remark-math": "^6.0.0",
    "rehype-katex": "^7.0.1"
  }
}
```

**í˜„í™©**: `node_modules` í¬ê¸° **578MB** (ë§¤ìš° í¼!)

**ë¬¸ì œì **:
- ğŸ”´ **ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¤‘ë³µ**: Plotly.js (800KB) + ECharts (600KB) ë™ì‹œ ì‚¬ìš©
  - ë‘ ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª¨ë‘ ì™„ì „í•œ ê¸°ëŠ¥ í¬í•¨
  - ë²ˆë“¤ì—ì„œ **1.4MB+** ì°¨ì§€

- ğŸ”´ **ë™ì  import ë¯¸ì ìš©**: vite.config.jsì— manualChunks ë¶„í•  ìˆìœ¼ë‚˜, ì‹¤ì œ lazy loading ë¶€ì¬
  ```javascript
  // vite.config.js (Line 121-126)
  manualChunks: {
    plotly: ['react-plotly.js', 'plotly.js-basic-dist-min'],
    'framer-motion': ['framer-motion'],
    chartjs: ['chart.js', 'react-chartjs-2'],
  },
  ```
  â†’ ì²­í¬ ë¶„í• ë§Œ ë˜ê³  lazy loadingì€ ë¯¸êµ¬í˜„

#### 2.2 ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ íŒ¨í„´

**TutorContext.jsx (Line 104-286)**: SSE ìŠ¤íŠ¸ë¦¬ë° ë©”ì‹œì§€ ì²˜ë¦¬ ì‹œ ê³¼ë„í•œ ìƒíƒœ ì—…ë°ì´íŠ¸

```jsx
// ë¬¸ì œ: ê° SSE ì²­í¬ë§ˆë‹¤ setMessages í˜¸ì¶œ (ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì—¬ëŸ¬ ë²ˆ)
setMessages((prev) =>
  prev.map((m) => (m.id === assistantMessage.id ? { ...m, content: fullContent } : m))
);
```

â†’ ì´ˆë‹¹ ìˆ˜ì‹­ ë²ˆì˜ ë¦¬ë Œë”ë§ ë°œìƒ ê°€ëŠ¥

**PortfolioContext.jsx (Line 41-43)**: useEffect ì˜ì¡´ì„± ì²´ì¸ì´ ê¸¸ì–´ì§
```jsx
useEffect(() => {
  if (userId) {
    fetchSummary();
    fetchPortfolio();
  } else {
    // ... ì´ˆê¸°í™”
  }
}, [fetchSummary, fetchPortfolio, userId]); // 3ê°œ ì˜ì¡´ì„±
```

â†’ fetchSummary/fetchPortfolioê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ì¬ì‹¤í–‰

#### 2.3 ë©”ëª¨ì´ì œì´ì…˜ ìƒí™©

**UserContext.jsx (Line 126-142)**: useMemo ì ìš©ë¨
```jsx
const value = useMemo(() => ({
  user, settings, isLoading, ...
}), [
  user, settings, isLoading, updateSettings, ...
]); // 12ê°œ ì˜ì¡´ì„±
```

**Portfolio.jsx**: HoldingCardì— React.memo ì ìš©
```jsx
const HoldingCard = React.memo(function HoldingCard({ holding, onClick }) { ... });
```

**TutorContext.jsx**: ê³¼ë„í•œ useMemo ì˜ì¡´ì„± (Line 340-378)
```jsx
const value = useMemo(() => ({
  // 18ê°œ ìƒíƒœ/í•¨ìˆ˜
}), [
  isOpen, openTutor, closeTutor, messages, isLoading,
  sendMessage, clearMessages, contextInfo, currentTerm,
  sessions, activeSessionId, createNewChat, deleteChat,
  loadChatHistory, refreshSessions, requestVisualization,
  agentStatus,
]); // 17ê°œ ì˜ì¡´ì„± â†’ ë©”ëª¨ì´ì œì´ì…˜ íš¨ê³¼ ê°ì†Œ
```

â†’ ì˜ì¡´ì„±ì´ ë„ˆë¬´ ë§ìœ¼ë©´ useMemoì˜ íš¨ê³¼ê°€ ì œí•œì 

---

### 3. ìƒíƒœ ê´€ë¦¬ ë¶„ì„

#### 3.1 Context êµ¬ì¡°ì™€ ë²”ìœ„

| Context | í¬ê¸° | êµ¬ë…ì | ë¬¸ì œì  |
|---------|------|--------|--------|
| UserContext | ì¤‘ | ì „ì—­ | settingsë¥¼ localStorage ë™ê¸°í™”í•˜ë©° ë§¤ë²ˆ ì €ì¥ (Line 36-38) |
| PortfolioContext | ì¤‘ | í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë ¨ í˜ì´ì§€ | userId ë³€ê²½ ì‹œë§ˆë‹¤ 2ê°œ API í˜¸ì¶œ (Line 81-91) |
| TutorContext | ëŒ€ | íŠœí„° í˜ì´ì§€ + ChatFAB | 18ê°œ ìƒíƒœ/í•¨ìˆ˜, ê³¼ë„í•˜ê²Œ í¼ |
| TermContext | ì†Œ | ë‚´ëŸ¬í‹°ë¸Œ ë‚´ ìš©ì–´ | ì ì ˆí•œ í¬ê¸° |
| ThemeContext | ì†Œ | ë ˆì´ì•„ì›ƒ ì „ì—­ | ì ì ˆí•œ í¬ê¸° |

**ë¬¸ì œì **:
- ğŸ”´ **TutorContextê°€ ê³¼ë„í•˜ê²Œ ì»¤ì§**: 
  - 18ê°œ ìƒíƒœ/í•¨ìˆ˜ ë…¸ì¶œ
  - ë©”ì‹œì§€ ë°°ì—´ ì „ì²´ë¥¼ Contextì— ë³´ìœ  (ìˆ˜ë°± ê°œ ë©”ì‹œì§€ ì‹œ ì„±ëŠ¥ ì €í•˜)
  - ì„¸ì…˜ ëª©ë¡, í™œì„± ì„¸ì…˜, í˜„ì¬ ìš©ì–´ ë“± ê´€ë ¨ ì—†ëŠ” ìƒíƒœ í˜¼ì¬

**ê¶Œì¥ì‚¬í•­**:
```
TutorContext ë¶„í• :
- ChatContext: messages, isLoading, sendMessage, agentStatus
- SessionContext: sessions, activeSessionId, createNewChat, deleteChat
- TutorUIContext: isOpen, openTutor, closeTutor, contextInfo, currentTerm
```

#### 3.2 ì „ì—­ vs ë¡œì»¬ ìƒíƒœ ë¶„ë¦¬

**Home.jsx (Line 17-37)**: ë¡œì»¬ ìƒíƒœ
```jsx
const [keywords, setKeywords] = useState([]);        // ë¡œì»¬ âœ…
const [isLoadingKeywords, setIsLoadingKeywords] = useState(true); // ë¡œì»¬ âœ…
```

**Portfolio.jsx**: ë¡œì»¬ ìƒíƒœ + Context í˜¼í•©
```jsx
const { portfolio, summary, refreshPortfolio } = usePortfolio(); // ì „ì—­ âœ…
const [tradeModal, setTradeModal] = useState({ ... }); // ë¡œì»¬ âœ…
```

**ë¶„ì„**: ì ì ˆí•˜ê²Œ ë¶„ë¦¬ë¨ âœ…

---

### 4. UX/ì ‘ê·¼ì„±

#### 4.1 ì—ëŸ¬ ì²˜ë¦¬

**ErrorBoundary.jsx** (`/home/hj/2026/project/adelie-investment/frontend/src/components/common/ErrorBoundary.jsx`)

```jsx
export default class ErrorBoundary extends Component {
  // ë Œë”ë§ ì¤‘ ì—ëŸ¬ë§Œ ìºì¹˜ (ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬/ë¹„ë™ê¸° ì—ëŸ¬ëŠ” ë¯¸ì²˜ë¦¬)
  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }
}
```

**ë¬¸ì œì **:
- ğŸ”´ **ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì—ëŸ¬ ë¯¸ì²˜ë¦¬**: try-catchê°€ ì—†ëŠ” async í•¨ìˆ˜
  ```jsx
  // TutorContext.jsx (Line 104-286)
  const sendMessage = useCallback(async (message, difficulty = 'beginner') => {
    // ... try-catch ìˆì§€ë§Œ ê²½ê³„ ì™¸ë¶€
  }, ...);
  ```

- ğŸŸ¡ **ìë™ ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬**: client.js (Line 42-50)ì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ì²˜ë¦¬
  ```jsx
  const handleAuthFailure = () => {
    localStorage.removeItem('token');
    window.dispatchEvent(new Event('auth:logout'));
    window.location.assign('/auth');
  };
  ```
  â†’ í™”ë©´ ê¹œë¹¡ì„ ë°œìƒ ê°€ëŠ¥, ë” ìš°ì•„í•œ ì²˜ë¦¬ í•„ìš”

#### 4.2 ë¡œë”© ìƒíƒœ ì²˜ë¦¬

**ì¼ê´€ì **:
```jsx
// Home.jsx (Line 18)
const [isLoadingKeywords, setIsLoadingKeywords] = useState(true);

// PortfolioContext.jsx (Line 11)
const [isLoading, setIsLoading] = useState(false);
```

â†’ ë„¤ì´ë° ì¼ê´€ì„± ìˆìŒ âœ…

**Toast ì•Œë¦¼**: ToastProvider êµ¬í˜„ë¨ âœ…
```jsx
// Toast.jsx (Line 18-36)
<AnimatePresence>
  {toasts.map(toast => (
    <motion.div key={toast.id} ... />
  ))}
</AnimatePresence>
```

#### 4.3 ëª¨ë°”ì¼ ëŒ€ì‘ (max-width: 480px)

**tailwind.config.js**ì—ì„œ ëª¨ë°”ì¼ í”„ë¦¬ìŠ¤íŠ¸ í™•ì¸:
```javascript
max-width-mobile: '480px',  // ì ì ˆ
```

**Home.jsx (Line 64)**: ì ì ˆí•œ padding/spacing
```jsx
<div className="min-h-screen bg-[#f9fafb] pb-24">
  <main className="container space-y-6 py-4 sm:space-y-7 sm:py-5">
```

â†’ ëª¨ë°”ì¼ ëŒ€ì‘ ì˜ ë¨ âœ…

---

### 5. ì½”ë“œ í’ˆì§ˆ

#### 5.1 íƒ€ì… ì•ˆì •ì„±

**í˜„í™©**: **prop-types / TypeScript ë¯¸ì‚¬ìš©**

```jsx
// Narrative.jsx - prop ê²€ì¦ ì—†ìŒ
export default function Narrative() {
  const { caseId } = useParams(); // useParams ë°˜í™˜ê°’ ê²€ì¦ ì—†ìŒ
  // ...
}

// MessageBubble.jsx - prop ê²€ì¦ ì—†ìŒ
function SourceBadge({ sources }) {
  // sourcesê°€ ë°°ì—´ì¸ì§€ ê²€ì¦ ì—†ìŒ
  return sources.map((s, i) => ...);
}
```

**ë¬¸ì œì **:
- ğŸ”´ **ëŸ°íƒ€ì„ ì—ëŸ¬ ê°€ëŠ¥ì„±**: undefined/null ì²´í¬ ë¶€ì¡±
- ğŸ”´ **IDE ìë™ì™„ì„± ë¯¸ì§€ì›**: í•¨ìˆ˜ ì‹œê·¸ë‹ˆì²˜ê°€ ë¶ˆëª…í™•

**ê¶Œì¥ì‚¬í•­**:
```jsx
// ìµœì†Œí•œ prop-types ì¶”ê°€
import PropTypes from 'prop-types';

MessageBubble.propTypes = {
  message: PropTypes.shape({
    id: PropTypes.number.isRequired,
    role: PropTypes.oneOf(['user', 'assistant', 'visualization']).isRequired,
    content: PropTypes.string,
  }).isRequired,
};
```

#### 5.2 ê³µí†µ ì»´í¬ë„ŒíŠ¸ ì¬ì‚¬ìš©ì„±

**ì¬ì‚¬ìš© ê°€ëŠ¥í•œ ì»´í¬ë„ŒíŠ¸**:
- âœ… `PenguinLoading.jsx`: ë¡œë”© ìƒíƒœ í‘œì‹œ
- âœ… `Toast.jsx`: ì•Œë¦¼ ë©”ì‹œì§€
- âœ… `ErrorBoundary.jsx`: ì—ëŸ¬ ì²˜ë¦¬

**ì¬ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ ì»´í¬ë„ŒíŠ¸**:
- ğŸ”´ `HoldingCard` (Portfolio.jsx ë‚´ ì •ì˜): Portfolio.jsxì—ë§Œ ì‚¬ìš©
- ğŸ”´ `MessageBubble` (ë„ˆë¬´ í¬ê³  ê´€ë ¨ ë¡œì§ ë§ìŒ): íŠœí„° ì „ìš©

#### 5.3 CSS ë³€ìˆ˜ vs Tailwind í˜¼ìš©

**globals.css (Line 7-69)**: CSS ë³€ìˆ˜ ì •ì˜
```css
:root {
  --color-background: #ffffff;
  --color-primary: #FF6B00;
  --glass-bg: rgba(255, 255, 255, 0.7);
}
```

**tailwind.config.js**: CSS ë³€ìˆ˜ í™œìš©
```javascript
colors: {
  background: 'var(--color-background)',
  primary: '#FF6B00',  // ì¤‘ë³µ!
}
```

**ë¬¸ì œì **:
- ğŸŸ¡ **ì¼ë¶€ ì»¬ëŸ¬ê°€ ì¤‘ë³µ ì •ì˜**: primary ìƒ‰ì´ tailwind.config.jsì—ì„œë„ í•˜ë“œì½”ë”©ë¨
- ğŸŸ¡ **Glassmorphism ë³€ìˆ˜ Tailwindì—ì„œ ë¯¸ì‚¬ìš©**: ì§ì ‘ classNameìœ¼ë¡œ rgba ì…ë ¥

```jsx
// Home.jsx (Line 68)
<section className="... bg-[#ff7648] ..."> {/* tailwind í´ë˜ìŠ¤ */}
```

â†’ CSS ë³€ìˆ˜ ì‹œìŠ¤í…œì´ ì™„ì „íˆ í™œìš©ë˜ì§€ ì•ŠìŒ

---

### 6. API ë ˆì´ì–´ êµ¬ì¡°

#### 6.1 fetchJson/postJson êµ¬í˜„

**íŒŒì¼**: `/home/hj/2026/project/adelie-investment/frontend/src/api/client.js`

**ê¸ì •ì  ì¸¡ë©´**:
- âœ… ì¤‘ì•™í™”ëœ ì—ëŸ¬ í•¸ë“¤ë§: `readErrorMessage()` (Line 53-56)
- âœ… í† í° ìë™ ê°±ì‹ : `refreshAccessToken()` (Line 58-90)
- âœ… 401 ìë™ ì¬ì‹œë„ (Line 99-116)
- âœ… ì¸ì¦ ìš°íšŒ ê²½ë¡œ ì„¤ì • (Line 8-12)

**êµ¬í˜„**:
```jsx
export const fetchJson = async (url) => {
  const response = await authFetch(url);
  if (!response.ok) {
    throw new Error(await readErrorMessage(response));
  }
  return response.json();
};
```

â†’ ê¹”ë”í•œ API âœ…

#### 6.2 ë„ë©”ì¸ë³„ API íŒŒì¼

**í˜„í™©**:
- `/api/auth.js` - ì¸ì¦
- `/api/portfolio.js` - í¬íŠ¸í´ë¦¬ì˜¤
- `/api/narrative.js` - ë‚´ëŸ¬í‹°ë¸Œ
- `/api/learning.js` - í•™ìŠµ
- `/api/quiz.js` - í€´ì¦ˆ

**portfolio.js ì˜ˆì‹œ** (Line 1-60):
```javascript
export const portfolioApi = {
  getPortfolio: () => fetchJson(`${API_BASE_URL}/api/v1/portfolio`),
  getPortfolioSummary: () => fetchJson(`${API_BASE_URL}/api/v1/portfolio/summary`),
  executeTrade: (tradeData) => postJson(`${API_BASE_URL}/api/v1/portfolio/trade`, tradeData),
  // ...
};
```

**ë¬¸ì œì **:
- ğŸŸ¡ **API_BASE_URLì´ client.jsì—ì„œ import**: ì„¤ì •ì´ ë¶„ì‚°ë¨
  ```jsx
  // client.js (Line 4)
  import { API_BASE_URL } from '../config';
  
  // ë‹¤ë¥¸ íŒŒì¼ì—ì„œ
  import { API_BASE_URL } from '../api/client';
  ```

---

### 7. ì£¼ìš” ê°œì„  í¬ì¸íŠ¸ ìš”ì•½

| ìš°ì„ ìˆœìœ„ | í•­ëª© | ì‹¬ê°ë„ | ì˜ˆìƒ ì˜í–¥ |
|---------|------|--------|----------|
| ğŸ”´ ë†’ìŒ | TutorContext ë¶„í•  (18ê°œ ìƒíƒœ/í•¨ìˆ˜) | ì„±ëŠ¥ | ì±„íŒ… ë©”ì‹œì§€ 100+ ì‹œ ë ‰ |
| ğŸ”´ ë†’ìŒ | ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ í†µí•© (Plotly + ECharts ì¤‘ë³µ) | ë²ˆë“¤ | 1.4MB ê°ì†Œ |
| ğŸ”´ ë†’ìŒ | SSE ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ ìµœì í™” | ì„±ëŠ¥ | CPU ì‚¬ìš©ëŸ‰ 30% ê°ì†Œ |
| ğŸŸ¡ ì¤‘ê°„ | TypeScript ë˜ëŠ” prop-types ë„ì… | ì•ˆì •ì„± | ëŸ°íƒ€ì„ ì—ëŸ¬ ë°©ì§€ |
| ğŸŸ¡ ì¤‘ê°„ | useFetch í›… ì¼ë°˜í™” | ì½”ë“œ í’ˆì§ˆ | ì¤‘ë³µ fetch ë¡œì§ ì œê±° |
| ğŸŸ¡ ì¤‘ê°„ | Provider êµ¬ë… ë²”ìœ„ ì„¸ë¶„í™” | ì„±ëŠ¥ | ë¶ˆí•„ìš”í•œ ë¦¬ë Œë”ë§ ê°ì†Œ |
| ğŸŸ¢ ë‚®ìŒ | CSS ë³€ìˆ˜ Tailwind ì™„ì „ í†µí•© | ìœ ì§€ë³´ìˆ˜ | í…Œë§ˆ ì „í™˜ ìš©ì´ |

---

### 8. êµ¬ì²´ì ì¸ ì½”ë“œ ì˜ˆì‹œ

#### 8.1 í˜„ì¬ ë¬¸ì œ: SSE ë©”ì‹œì§€ ê³¼ë„í•œ ì—…ë°ì´íŠ¸

```jsx
// TutorContext.jsx (Line 195-196) - í˜„ì¬ êµ¬í˜„
setMessages((prev) =>
  prev.map((m) => (m.id === assistantMessage.id ? { ...m, content: fullContent } : m))
);
```

â†’ ì´ˆë‹¹ 10-20íšŒ í˜¸ì¶œ ê°€ëŠ¥ (1KB í…ìŠ¤íŠ¸ = 20ì ë‹¨ìœ„)

#### 8.2 ê°œì„  ì•ˆ: ë””ë°”ìš´ì‹± + ë°°ì¹˜ ì—…ë°ì´íŠ¸

```jsx
// ê¶Œì¥ì‚¬í•­: 50ms ë””ë°”ìš´ì‹±
const updateMessageDebounced = useMemo(
  () => debounce((content) => {
    setMessages(prev => 
      prev.map(m => m.id === assistantMessage.id ? { ...m, content } : m)
    );
  }, 50),
  [assistantMessage.id]
);
```

#### 8.3 í˜„ì¬ ë¬¸ì œ: useEffect ì˜ì¡´ì„± ì²´ì¸

```jsx
// PortfolioContext.jsx (Line 81-91)
useEffect(() => {
  if (userId) {
    fetchSummary();     // ì˜ì¡´ì„±: [userId]
    fetchPortfolio();   // ì˜ì¡´ì„±: [userId]
  } else {
    // ...
  }
}, [fetchSummary, fetchPortfolio, userId]); // 3ê°œ ì˜ì¡´ì„± â†’ ê³„ë‹¨ì‹ ì—…ë°ì´íŠ¸
```

â†’ fetchSummary/fetchPortfolio ë³€ê²½ ì‹œ ë¶ˆí•„ìš”í•œ ì¬ì‹¤í–‰

#### 8.4 ê°œì„  ì•ˆ: useCallbackìœ¼ë¡œ ì•ˆì •í™”

```jsx
// ê¶Œì¥ì‚¬í•­
const fetchPortfolioData = useCallback(() => {
  if (!userId) return;
  Promise.all([fetchSummary(), fetchPortfolio()]);
}, [userId]);

useEffect(() => {
  fetchPortfolioData();
}, [fetchPortfolioData]); // 1ê°œ ì˜ì¡´ì„±ë§Œ
```

---

### 9. ë²ˆë“¤ ë¶„ì„ ë° ìµœì í™” ëª©í‘œ

**í˜„ì¬**:
- node_modules: 578MB
- Plotly.js: 800KB
- ECharts: 600KB
- Total chart libs: 1.4MB (ì•½ 15-20% of bundle)

**ëª©í‘œ**:
1. ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ 1ê°œ ì„ íƒ (ECharts ë˜ëŠ” Plotly)
2. Lazy loading ì ìš©
3. ì˜ˆìƒ ê°ì†Œ: 400-500KB

```javascript
// vite.config.js ê°œì„ 
const PlotlyChart = lazy(() => import('./PlotlyChart'));
const EChart = lazy(() => import('./EChart'));

// ë˜ëŠ” ë™ì  import
const ChartComponent = isMobile ? EChart : PlotlyChart;
```

---

### 10. ê²€ì‚¬ëœ íŒŒì¼ ëª©ë¡

| íŒŒì¼ | ë¼ì¸ ìˆ˜ | ë¶„ë¥˜ | ìƒíƒœ |
|------|--------|------|------|
| App.jsx | 113 | ë¼ìš°í„° | í˜„ì¬ |
| src/contexts/*.jsx | ~500 | ìƒíƒœê´€ë¦¬ | ë¶„ì„ë¨ |
| src/pages/Home.jsx | 80+ | í˜ì´ì§€ | ìƒ˜í”Œ ë¶„ì„ |
| src/pages/Narrative.jsx | 100+ | í˜ì´ì§€ | ìƒ˜í”Œ ë¶„ì„ |
| src/pages/Portfolio.jsx | 200+ | í˜ì´ì§€ | ìƒ˜í”Œ ë¶„ì„ |
| src/api/*.js | ~300 | API ë ˆì´ì–´ | ë¶„ì„ë¨ |
| src/components/common/*.jsx | ~500 | ì»´í¬ë„ŒíŠ¸ | ë¶„ì„ë¨ |
| src/components/tutor/*.jsx | 569 | ì»´í¬ë„ŒíŠ¸ | ë¶„ì„ë¨ |
| src/hooks/*.js | ~40 | ì»¤ìŠ¤í…€ í›… | ë¶„ì„ë¨ |
| src/styles/globals.css | 120+ | ìŠ¤íƒ€ì¼ | ë¶„ì„ë¨ |
| package.json | 39 | ì˜ì¡´ì„± | ë¶„ì„ë¨ |
| vite.config.js | 130 | ë¹Œë“œ | ë¶„ì„ë¨ |
| tailwind.config.js | 50+ | ì„¤ì • | ë¶„ì„ë¨ |

**ì´ íŒŒì¼ íƒìƒ‰**: 106ê°œ JSX/JS íŒŒì¼ ì¤‘ ì£¼ìš” íŒŒì¼ ë¶„ì„ âœ…

---

### ê²°ë¡ 

**Adelie Investment í”„ë¡ íŠ¸ì—”ë“œëŠ” ê¸°ë³¸ êµ¬ì¡°ëŠ” ê²¬ê³ í•˜ì§€ë§Œ, ë‹¤ìŒ ì˜ì—­ì—ì„œ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤:**

1. **ì„±ëŠ¥ (Performance)**: TutorContext ë¶„í• , SSE ë©”ì‹œì§€ ë””ë°”ìš´ì‹±, ì°¨íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ í†µí•©
2. **íƒ€ì… ì•ˆì •ì„± (Type Safety)**: TypeScript ë˜ëŠ” prop-types ë„ì…
3. **ìƒíƒœ ê´€ë¦¬ (State Management)**: Context êµ¬ë… ë²”ìœ„ ì„¸ë¶„í™”, useEffect ì˜ì¡´ì„± ì •ë¦¬
4. **ë²ˆë“¤ ìµœì í™” (Bundle)**: Plotly.js + ECharts ì¤‘ë³µ ì œê±°, ë™ì  ì„í¬íŠ¸ í™œìš©

**í˜„ì¬ ìƒíƒœ**: í”„ë¡œë•ì…˜ ë°°í¬ ê°€ëŠ¥í•˜ë‚˜, ì¼ì¼ í™œë™ ì‚¬ìš©ì 50ëª… ì´ìƒ, ëŒ€í™” ë©”ì‹œì§€ 100+ ì‹œ ì„±ëŠ¥ ì €í•˜ ìš°ë ¤.</result>
<usage><total_tokens>63945</total_tokens><tool_uses>40</tool_uses><duration_ms>84753</duration_ms></usage>
</task-notification>
Full transcript available at: REDACTED.output

---

<task-notification>
<task-id>abb7f51cabee706e8</task-id>
<tool-use-id>toolu_01We7LFwT8wq6FZH6u8DwqFs</tool-use-id>
<status>completed</status>
<summary>Agent "FastAPI/chatbot/datapipeline ì½”ë“œ í’ˆì§ˆ ì‹¬ì¸µ ë¶„ì„" completed</summary>
<result>ì¶©ë¶„í•œ ì •ë³´ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤. ì´ì œ ì¢…í•©ì ì¸ ë¶„ì„ ë³´ê³ ì„œë¥¼ ì‘ì„±í•˜ê² ìŠµë‹ˆë‹¤.

---

# Adelie Investment ë°±ì—”ë“œ ì½”ë“œ í’ˆì§ˆ ë¶„ì„ ë³´ê³ ì„œ

## ì „ì²´ ìš”ì•½

**ë¶„ì„ ëŒ€ìƒ**: Adelie Investment (History Repeats Itself) ë°±ì—”ë“œ ì½”ë“œ
- FastAPI ê¸°ë°˜ API ì„œë²„ (í¬íŠ¸ 8082)
- datapipeline (LangGraph 18ë…¸ë“œ)
- chatbot (AI íŠœí„° ì—ì´ì „íŠ¸)
- PostgreSQL + Redis ê¸°ë°˜ ë°ì´í„° ê³„ì¸µ

**ì½”ë“œ ê·œëª¨**: ì•½ 512ì¤„ì˜ íŠœí„° ë¼ìš°íŠ¸ ì™¸ì—ë„ 20+ ë¼ìš°íŠ¸, 17+ ì„œë¹„ìŠ¤ íŒŒì¼, 9+ íŒŒì´í”„ë¼ì¸ ë…¸ë“œ ë“± ëŒ€ê·œëª¨ í”„ë¡œì íŠ¸

**ì¢…í•© í‰ê°€**: 6-7/10 - ê±´ì „í•œ êµ¬ì¡°ì´ë‚˜ **ì¤‘ìš”í•œ í’ˆì§ˆ ë° ë³´ì•ˆ ë¬¸ì œ** ì—¬ëŸ¿ ë°œê²¬

---

## 1. FastAPI í•µì‹¬ êµ¬ì¡° ë¶„ì„

### 1.1 main.py (ë¼ìš°í„° ë™ì  ë¡œë”©)

**í˜„ì¬ êµ¬í˜„** (lines 20-47):
```python
for _mod_name in ["health", "auth", "briefing", "cases", "tutor", ...]:
    try:
        _route_modules[_mod_name] = importlib.import_module(f"app.api.routes.{_mod_name}")
    except Exception as _e:
        _logging.getLogger("startup").warning(f"ë¼ìš°í„° '{_mod_name}' ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œ): {_e}")
```

**ë°œê²¬ëœ ë¬¸ì œ**:

1. **ê³¼ë„í•œ ì—ëŸ¬ ë¬´ì‹œ (ë„ˆë¬´ ë„ˆê·¸ëŸ¬ìš´ graceful fallback)**
   - ë¼ìš°í„° import ì‹¤íŒ¨ ì‹œ ì „ì²´ ì˜ˆì™¸ë¥¼ ì¡°ìš©íˆ ë¬´ì‹œ
   - ì‹¤ì œ ë²„ê·¸(ë¬¸ë²• ì˜¤ë¥˜, ìˆœí™˜ ì°¸ì¡°)ë¥¼ ìˆ¨ê¸¸ ìˆ˜ ìˆìŒ
   - í”„ë¡œë•ì…˜ì—ì„œ ì¹¨ë¬µì  ê¸°ëŠ¥ ì†ì‹¤

2. **ì‘ë‹µ í¬ì¥ ë¯¸ë“¤ì›¨ì–´ì˜ ì¤‘ë³µ ì²˜ë¦¬** (lines 201-233):
```python
# ì´ë¯¸ ì „ì—­ í¬ë§·ì´ë©´ ê·¸ëŒ€ë¡œ ë°˜í™˜
if isinstance(payload, dict) and payload.get("status") in {"success", "error"}:
    return response
```
   - ì§ê´€ì ì´ë‚˜ ì½”ë“œ ëƒ„ìƒˆ: ë¼ìš°íŠ¸ë³„ë¡œ ì¼ê´€ëœ ì‘ë‹µ í¬ë§·ì„ ê°•ì œí•˜ì§€ ì•ŠìŒ
   - ë¬¸ì„œí™” ë¶€ì¡±: ê°œë°œìê°€ ì–´ë–¤ í¬ë§·ì„ ë°˜í™˜í•´ì•¼ í•˜ëŠ”ì§€ ëª…í™•í•˜ì§€ ì•ŠìŒ

3. **ì „ì—­ ì˜ˆì™¸ í•¸ë“¤ëŸ¬ì˜ ì •ë³´ ë…¸ì¶œ ìœ„í—˜** (lines 112-135):
```python
logger.error("Unhandled exception [error_id=%s] %s %s: %s\n%s",
    error_id, request.method, request.url.path, exc, traceback.format_exc()
)
```
   - ë¡œê·¸ì—ëŠ” ì „ì²´ tracebackì´ í¬í•¨ë˜ì§€ë§Œ, ì‘ë‹µì—ëŠ” `error_id`ë§Œ ë°˜í™˜ (âœ“ ì¢‹ìŒ)
   - ë‹¤ë§Œ ë¡œê·¸ ìˆ˜ì¤€ì´ DEBUGì—¬ì•¼ í•  tracebackì´ ERRORë¡œ ê¸°ë¡ë˜ëŠ” ê²ƒì€ ë¡œê·¸ ë³¼ë¥¨ ì¦ëŒ€

### 1.2 config.py (í™˜ê²½ ì„¤ì •)

**ë¬¸ì œì **:

1. **ê¸°ë³¸ê°’ì´ ë„ˆë¬´ ê´€ëŒ€í•¨** (line 28):
```python
JWT_SECRET: str = "narrative-invest-jwt-secret-change-in-production"
```
   - í”„ë¡œë•ì…˜ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì˜ì¡´ (íœ´ë¨¼ ì—ëŸ¬ ìœ„í—˜)
   - í™˜ê²½ë³€ìˆ˜ ë°˜ë“œì‹œ ì„¤ì • ê²€ì¦ ë¡œì§ ë¶€ì¬

2. **ì—¬ëŸ¬ ë§Œë£Œ ì‹œê°„ ì„¤ì •ì˜ í˜¼ë™** (lines 30-33):
```python
JWT_EXPIRE_MINUTES: int = 30
ACCESS_TOKEN_EXPIRE_MINUTES: int = Field(60, ...)
JWT_ACCESS_EXPIRATION: int = Field(0, ...)  # ms
JWT_REFRESH_EXPIRATION: int = Field(0, ...)  # ms
```
   - **3ê°€ì§€ ë‹¤ë¥¸ ë‹¨ìœ„/ì´ë¦„ íŒ¨í„´** (ë¶„ vs ms)
   - `auth_service.py`ì˜ `_get_access_exp_seconds()`ê°€ ì´ë“¤ì„ ëª¨ë‘ ì²˜ë¦¬í•˜ë ¤ë‹¤ ë³µì¡í•´ì§
   - **ê¶Œì¥**: ë‹¨ì¼ ì„¤ì •ìœ¼ë¡œ í†µì¼ (`TOKEN_EXPIRE_SECONDS` ë“±)

3. **CORS ì„¤ì • ê²€ì¦ ë¶€ì¬** (line 52):
```python
CORS_ALLOWED_ORIGINS: str = "http://localhost:3000,http://localhost:5173"
```
   - í”„ë¡œë•ì…˜ì—ì„œ `localhost` í—ˆìš©í•˜ë©´ ì•ˆ ë¨
   - ë°°í¬ ì‹œ ì´ ê°’ì„ ì œëŒ€ë¡œ ë³€ê²½í•˜ëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ ì—†ìŒ

### 1.3 database.py (ì„¸ì…˜ ê´€ë¦¬)

**í˜„ì¬ ì„¤ì •**:
```python
pool_size=50, max_overflow=100, pool_timeout=30, pool_recycle=1800
```

**ë¬¸ì œì **:

1. **í’€ í¬ê¸° ì„¤ì •ì´ ê³¼ë„í•¨** (í•©ê³„ 150ê°œ ì—°ê²°)
   - ì‘ì€ íŒ€ í”„ë¡œì íŠ¸ì—ëŠ” `pool_size=10, max_overflow=20` ì •ë„ ì¶©ë¶„
   - ë©”ëª¨ë¦¬ ë‚­ë¹„ ë° DB ì—°ê²° ìˆ˜ ì œí•œ ì´ˆê³¼ ìœ„í—˜

2. **ì—°ê²° í’€ ì¬í™œìš© ì„¤ì •ì´ ë¶ˆëª…í™•**
   - `pool_recycle=1800`(30ë¶„)ì€ ê¸°ë³¸ ì •ìƒì´ë‚˜
   - DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘ì´ë©´ ì—°ê²° ì „í™˜ìœ¼ë¡œ ì¸í•œ ì˜¤ë¥˜ ê°€ëŠ¥

### 1.4 auth.py (JWT ì¸ì¦)

**í˜„ì¬ êµ¬í˜„**: HTTPBearer + JWT ë””ì½”ë”©

**ë¬¸ì œì **:

1. **í† í° í¬ê¸° ì œí•œ ì—†ìŒ**
   - ì•…ì˜ì  ì‚¬ìš©ìê°€ ë§¤ìš° í° JWT(ì˜ˆ: ë§¤ìš° í° `extra_claims`)ë¥¼ ì „ì†¡ ê°€ëŠ¥
   - CPU ìŠ¤íŒŒì´í¬ ë° ë©”ëª¨ë¦¬ ì˜¤ë²„ë¡œë“œ ê°€ëŠ¥

2. **í† í° ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€** (lines 49-50):
```python
logger.warning(f"Invalid token error: {e}, token_prefix: {token[:50] if token else 'None'}...")
```
   - í† í° í”„ë¦¬í”½ìŠ¤ë¥¼ ë¡œê·¸ì— ë‚¨ê¸°ëŠ” ê²ƒì€ **ë³´ì•ˆ ìœ„í—˜**
   - í† í°ì´ ìœ ì¶œë˜ë©´ ì´ ë¡œê·¸ë„ ë…¸ì¶œë  ìˆ˜ ìˆìŒ

3. **`_get_jwt_key()` í•¨ìˆ˜ì˜ ì•½í•œ í‚¤ íŒ¨ë”©** (lines 20-25):
```python
def _get_jwt_key(secret: str) -> bytes:
    key_bytes = secret.encode("utf-8")
    if len(key_bytes) < 32:
        key_bytes = key_bytes + b"\x00" * (32 - len(key_bytes))
    return key_bytes
```
   - **null byte paddingì€ ë³´ì•ˆìƒ ì•½í•¨** (JWT_SECRETì´ ì¶©ë¶„íˆ ê°•ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ì•Œê³ ë¦¬ì¦˜ ì•½í™”)
   - **ê¶Œì¥**: ìµœì†Œ 32ë°”ì´íŠ¸ secret ê°•ì œ + `HMAC-SHA256`ì˜ í‚¤ ë„ì¶œ í•¨ìˆ˜(PBKDF2 ë“±) ì‚¬ìš©

---

## 2. ì¸ì¦ ë° í† í° ê´€ë¦¬ (auth_service.py)

### 2.1 íšŒì›ê°€ì…/ë¡œê·¸ì¸ ë¡œì§

**ì¢‹ì€ ì **:
- bcryptë¥¼ ì‚¬ìš©í•œ ì ì ˆí•œ ë¹„ë°€ë²ˆí˜¸ í•´ì‹± âœ“
- ì´ë©”ì¼ ë„ë©”ì¸ í•„í„°ë§ (tempmail.com ë“± ì°¨ë‹¨) âœ“
- ì‚¬ìš©ìëª… ì •ê·œí‘œí˜„ì‹ ê²€ì¦ âœ“

**ë¬¸ì œì **:

1. **Refresh Token ì¬ì‚¬ìš© ê°ì§€ ë¡œì§ì´ ìˆìœ¼ë‚˜ ë¶ˆì™„ì „** (lines 313-318):
```python
if not stored_hash or stored_hash != incoming_hash:
    # Possible reuse or token store mismatch: revoke all refresh tokens
    await _revoke_user_refresh_tokens(user.id)
    raise HTTPException(...)
```
   - âœ“ ì¬ì‚¬ìš© ê°ì§€ ìì²´ëŠ” ì¢‹ìŒ
   - âœ— í•˜ì§€ë§Œ **ê³µê²©ìê°€ ì´ë¯¸ í† í°ì„ ì‚¬ìš©í–ˆë‹¤ë©´ í”¼í•´ í›„ ê°ì§€**
   - **ê¶Œì¥**: Redisì— í† í° ë§Œë£Œ ì‹œê°„ + ê°ì§€ í›„ alerting/logging ê°•í™”

2. **Access Tokenê³¼ Refresh Tokenì˜ ë¹„ëŒ€ì¹­ ê´€ë¦¬**
   - Access Tokenì€ JWTë§Œ ì‚¬ìš© (stateless)
   - Refresh Tokenì€ Redis ì €ì¥ (stateful)
   - **ê°œë…ì€ ë§ìœ¼ë‚˜**: Access Token íê¸° ë¶ˆê°€ëŠ¥ (íƒˆì·¨ í›„ ë§Œë£Œê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥)
   - **ê¶Œì¥**: í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìœ ì§€ ë˜ëŠ” ì§§ì€ Access Token ë§Œë£Œ ì‹œê°„ (15ë¶„)

3. **ë¡œê·¸ì¸ í›„ `last_login_at` ì—…ë°ì´íŠ¸ ê²½í•©** (line 228):
```python
user.last_login_at = datetime.utcnow()  # UTCì¸ë°, KSTë¡œ ì €ì¥í•´ì•¼ í•  ìˆ˜ë„
await db.commit()
```
   - **ë¬¸ì œ**: ë§ˆì´í¬ë¡œì´ˆ ì •ë°€ë„ë¡œ ì—…ë°ì´íŠ¸í•˜ë©´ DB ë¶€í•˜ ì¦ê°€
   - **ê¶Œì¥**: `last_login_date` (ì¼ì¼ ë‹¨ìœ„)ë¡œ ë³€ê²½ ë° ìºì‹œ ì¶”ê°€

---

## 3. íŠœí„° ë¼ìš°íŠ¸ (tutor.py) - **ê°€ì¥ ë³µì¡í•œ ì—”ë“œí¬ì¸íŠ¸**

### 3.1 ì „ì²´ êµ¬ì¡°ì˜ ë¬¸ì œì 

**íŒŒì¼ í¬ê¸°**: 512ì¤„ (ë§¤ìš° í¼)

**ë¬¸ì œì **:

1. **ë‹¨ì¼ ì±…ì„ ì›ì¹™ ìœ„ë°°**
   - `generate_tutor_response()` í•¨ìˆ˜ê°€ 145ì¤„ (lines 140-284)
   - ì—­í• : LLM í˜¸ì¶œ + ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘ + ê°€ë“œë ˆì¼ ê²€ì‚¬ + ì‹œê°í™” ìƒì„± + DB ì €ì¥
   - **ëª¨ë‘ í•œ í•¨ìˆ˜ì— ë­‰ì³ìˆìŒ**

2. **ê°€ë“œë ˆì¼ ê²€ì‚¬ í›„ ì§„í–‰ì´ ì´ìƒí•¨** (lines 153-209):
```python
yield f"event: text_delta\ndata: {json.dumps({'content': guardrail_result.block_message})}\n\n"

try:
    # ... DB ì €ì¥ ...
    await db.commit()
except Exception as e:
    logger.warning("ê°€ë“œë ˆì¼ ì°¨ë‹¨ ë‚´ì—­ DB ì €ì¥ ì‹¤íŒ¨: %s", e)

yield f"event: done\ndata: {json.dumps({'session_id': session_id, ...})}\n\n"
return
```
   - ê°€ë“œë ˆì¼ì´ ì°¨ë‹¨í•´ë„ **DBì— ì €ì¥í•˜ë ¤ ì‹œë„**
   - DB ì €ì¥ ì‹¤íŒ¨ ì‹œ **ë¬´ì‹œí•˜ê³  ê³„ì†** (ì‚¬ìš©ìëŠ” ë¬¸ì œ ì—†ëŠ” ê²ƒì²˜ëŸ¼ ìƒê°)
   - **ê¶Œì¥**: ê°€ë“œë ˆì¼ ì°¨ë‹¨ â†’ ì¦‰ì‹œ return (DB ì €ì¥ X)

3. **ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘ì˜ N+1 ë¬¸ì œ** (lines 231-264):
```python
# DB ê¸°ë°˜ ìš”ì•½ ì‚¬ìš©
if request.context_type == "briefing":
    ctx_result = await db.execute(text(
        "SELECT market_summary, top_keywords FROM daily_briefings WHERE id = :id"
    ), {"id": request.context_id})
elif request.context_type == "case":
    ctx_result = await db.execute(text(...))
# ... í¬íŠ¸í´ë¦¬ì˜¤ë„ ë³„ë„ ì¿¼ë¦¬
portfolio_result = await db.execute(text(...))
```
   - ê° ì»¨í…ìŠ¤íŠ¸ íƒ€ì…ë§ˆë‹¤ ë³„ë„ ì¿¼ë¦¬
   - `context_text` ì „ë‹¬ ì‹œ ë¶ˆí•„ìš”í•œ DB ì¡°íšŒ
   - **ê¶Œì¥**: ë‹¨ì¼ ì¿¼ë¦¬ë¡œ í†µí•©í•˜ê±°ë‚˜ ìºì‹œ ì‚¬ìš©

4. **ì‹œê°í™” ìƒì„±ì—ì„œ LLM ìŠ¤ìœ„ì¹­** (lines 411-471):
```python
# Claude Haiku ì‚¬ìš©
claude_client = anthropic.AsyncAnthropic(api_key=claude_api_key)
viz_response = await claude_client.messages.create(
    model="claude-3-5-haiku-20241022",
    ...
)
# Fallback to OpenAI
if not claude_api_key:
    viz_response = await client.chat.completions.create(...)
```
   - âœ“ Claudeë¡œ ì‹œê°í™”ë¥¼ í•˜ëŠ” ê²ƒì€ ì°½ì˜ì 
   - âœ— **ë¹„ìš© ìµœì í™” ë¯¸í¡**: "gpt-5-mini" ëŒ€ì‹  Haiku(ë” ì €ë ´)ë¥¼ ì‚¬ìš©í•˜ëŠ” ê±´ ì¢‹ìœ¼ë‚˜
   - âœ— **ëª¨ë¸ëª… í˜¼ë™**: `gpt-5-mini`ëŠ” ì¡´ì¬í•˜ì§€ ì•ŠìŒ (ì•„ë§ˆë„ `gpt-4o-mini` ì˜¤íƒ€)

5. **SSE ìŠ¤íŠ¸ë¦¬ë° íƒ€ì„ì•„ì›ƒ ë¡œì§** (lines 340-348):
```python
if chunk_count % 10 == 0:
    if time.monotonic() - stream_start > 300:
        logger.warning("SSE ìŠ¤íŠ¸ë¦¬ë° íƒ€ì„ì•„ì›ƒ (300ì´ˆ ì´ˆê³¼)")
        yield f"event: error\ndata: {json.dumps({'type': 'error', 'error': 'Stream timeout'})}\n\n"
        break
    if await http_request.is_disconnected():
        logger.info("í´ë¼ì´ì–¸íŠ¸ ì—°ê²° í•´ì œ ê°ì§€")
        break
```
   - âœ“ íƒ€ì„ì•„ì›ƒê³¼ ì—°ê²° í•´ì œ ê°ì§€ëŠ” ì¢‹ìŒ
   - âœ— ê·¸ëŸ¬ë‚˜ **5ë¶„ íƒ€ì„ì•„ì›ƒì€ ë„ˆë¬´ ê¹€** (LLM ì‘ë‹µì´ ëŠë¦¬ë©´ í´ë¼ì´ì–¸íŠ¸ê°€ ë¨¼ì € ë– ë‚¨)
   - âœ— **ë§¤ 10 ì²­í¬ë§ˆë‹¤ í™•ì¸**: ì²­í¬ ì†ë„ì— ë”°ë¼ ê²€ì‚¬ ë¹ˆë„ê°€ ë‹¬ë¼ì§
   - **ê¶Œì¥**: íƒ€ì´ë¨¸ ê¸°ë°˜ + 1ë¶„ ì´ë‚´ ì„¤ì •

6. **DB ì»¤ë°‹ í›„ ë™ê¸°í™” ë¬¸ì œ** (lines 399-401):
```python
await db.commit()
except Exception as e:
    logger.warning("Failed to save tutor session: %s", e)
```
   - ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨ ì‹œ **ë¬´ì‹œ**
   - **ê¶Œë™**: ìµœì†Œí•œ DB ì €ì¥ ì¬ì‹œë„ ë˜ëŠ” ë‹¤ë¥¸ ì €ì¥ì†Œ(Redis) ì‚¬ìš©

### 3.2 ë³´ì•ˆ ë¬¸ì œ

1. **ë©”ì‹œì§€ ë‚´ìš©ì„ DBì— ê·¸ëŒ€ë¡œ ì €ì¥** (lines 186-190, 379-393):
   - ì‚¬ìš©ìì˜ ë¯¼ê°í•œ ì§ˆë¬¸ì´ í‰ë¬¸ìœ¼ë¡œ ì €ì¥ë¨
   - ë°ì´í„° ìœ ì¶œ ì‹œ ìœ„í—˜
   - **ê¶Œì¥**: ì±„íŒ… ë©”ì‹œì§€ëŠ” ì•”í˜¸í™”í•˜ê±°ë‚˜ ìµëª…í™”

2. **ìš©ì–´ ì„¤ëª… ì—”ë“œí¬ì¸íŠ¸ì˜ SQL Injection ìœ„í—˜ì€ ë‚®ìŒ** (lines 99-110):
```python
select(Glossary).where(
    Glossary.term.ilike(f"%{term}%"),  # ORM ì‚¬ìš©ì´ë¯€ë¡œ ì•ˆì „
    Glossary.difficulty == difficulty,
)
```
   - âœ“ SQLAlchemy ORM ì‚¬ìš©ìœ¼ë¡œ ì¸í•´ SQL Injection ì—†ìŒ
   - âœ“ í•˜ì§€ë§Œ `term` ë§¤ê°œë³€ìˆ˜ê°€ ë§¤ìš° ê¸¸ë©´ ì •ê·œí‘œí˜„ì‹ ì„±ëŠ¥ ì €í•˜

---

## 4. Data Pipeline (datapipeline/) - LangGraph 18ë…¸ë“œ

### 4.1 graph.py ë° ë…¸ë“œ ì„¤ê³„

**êµ¬ì¡°**:
- START â†’ [ë¼ìš°í„°] â†’ crawlers â†’ screening â†’ curation â†’ interface1/2/3 â†’ DB ì €ì¥ â†’ END
- ë³‘ë ¬ ì‹¤í–‰: asyncio.gatherë¡œ í¬ë¡¤ë§, ìš”ì•½, ì‹œê°í™” ë³‘ë ¬í™”

**ë¬¸ì œì **:

1. **ìƒíƒœ(State) íƒ€ì…ì´ ë„ˆë¬´ í¬ë‹¤** (lines 66-127):
```python
class BriefingPipelineState(TypedDict):
    # ì…ë ¥
    input_path: Optional[str]
    topic_index: int
    backend: str
    market: str
    # Data Collection (8ê°œ í•„ë“œ)
    raw_news: Optional[list]
    raw_reports: Optional[list]
    ...
    # Interface 1/2/3 (15+ í•„ë“œ)
```
   - **State dictê°€ 35+ í•„ë“œ í¬í•¨**
   - ê° ë…¸ë“œê°€ í•„ìš”í•œ í•„ë“œê°€ ëª…ì‹œë˜ì§€ ì•ŠìŒ
   - **ê¶Œì¥**: `@dataclass`ë¡œ ì •ë¦¬í•˜ê³ , ê° ë…¸ë“œë³„ ì…ì¶œë ¥ ëª…ì‹œ

2. **ë…¸ë“œ ì‹¤íŒ¨ ì‹œ ë¡¤ë°± ë©”ì»¤ë‹ˆì¦˜ ë¶€ì¬**
   - í¬ë¡¤ë§ ì‹¤íŒ¨ â†’ `raw_news = []` (ë¹„ì¹˜ëª…ì ìœ¼ë¡œ ì§„í–‰)
   - DB ì €ì¥ ì‹¤íŒ¨ â†’ íŒŒì´í”„ë¼ì¸ ê²°ê³¼ ì†ì‹¤
   - **ê¶Œì¥**: íŠ¸ëœì­ì…˜ ë˜ëŠ” ì‹¤íŒ¨ ì¬ì‹œë„ ë©”ì»¤ë‹ˆì¦˜

3. **ì„¤ì • í˜¼ë™** (datapipeline/config.py):
   - `DEFAULT_MODEL = "claude-sonnet-4-20250514"` (ìµœì‹ )
   - `CHART_MODEL = "gpt-4o-mini"`
   - `CHART_AGENT_MODEL = "gpt-5-mini"` (ì¡´ì¬í•˜ì§€ ì•ŠìŒ)
   - **ê¶Œì¥**: ì¡´ì¬í•˜ëŠ” ëª¨ë¸ë§Œ ì‚¬ìš© (gpt-4o-mini, claude-sonnet-4 ë“±)

### 4.2 multiProvider Client (ai/multi_provider_client.py)

**ì¢‹ì€ ì **:
- OpenAI, Perplexity, Anthropic í†µí•©
- ë™ì‹œì„± ì œí•œ (Semaphore ì‚¬ìš©)
- ì¬ì‹œë„ ë¡œì§ ìˆìŒ

**ë¬¸ì œì **:

1. **ë™ì‹œì„± ì œí•œì´ ë„ˆë¬´ ë‚®ìŒ** (lines 25-28):
```python
LLM_MAX_CONCURRENCY = max(1, int(os.getenv("LLM_MAX_CONCURRENCY", "6")))
OPENAI_MAX_CONCURRENCY = max(1, int(os.getenv("OPENAI_MAX_CONCURRENCY", "4")))
```
   - OpenAI ê¸°ë³¸ê°’ 4ëŠ” í•©ë¦¬ì ì´ë‚˜
   - ì „ì²´ LLM 6ì€ ë‹¤ì¤‘ ë…¸ë“œ ë³‘ë ¬ ì‹¤í–‰ ì‹œ ë³‘ëª©
   - **ê¶Œì¥**: ë™ì  ì¡°ì • ë˜ëŠ” í™˜ê²½ë³„ ì„¤ì •

2. **API íƒ€ì„ì•„ì›ƒì´ ê¸¸ë‹¤** (lines 23-24):
```python
OPENAI_TIMEOUT_SECONDS = float(os.getenv("OPENAI_TIMEOUT_SECONDS", "180"))  # 3ë¶„
PERPLEXITY_TIMEOUT_SECONDS = float(os.getenv("PERPLEXITY_TIMEOUT_SECONDS", "60"))
```
   - 3ë¶„ì€ í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ë„ˆë¬´ ê¹€
   - **ê¶Œì¥**: 30ì´ˆ (OpenAI) / 20ì´ˆ (Perplexity)

---

## 5. Chatbot & Guardrail System

### 5.1 guardrail.py (LangGraph ê¸°ë°˜)

**í˜„ì¬ êµ¬í˜„**:
```python
decision = "SAFE" | "ADVICE" | "OFF_TOPIC" | "MALICIOUS"
```

**ë¬¸ì œì **:

1. **ì¬ì‹œë„ ë¡œì§ì´ ë¶ˆì™„ì „** (lines 44-80):
```python
if retries > 0:
    prefix = "JSON í˜•ì‹ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤..."
response = await llm.ainvoke([...])
parsed = json.loads(content)
```
   - `MAX_RETRIES = 2`ì´ë‚˜ ì¬ì‹œë„ ë¡œì§ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ
   - íŒŒì‹± ì‹¤íŒ¨ ì‹œ `PARSE_ERROR` ë°˜í™˜ í›„ ì ˆì°¨ê°€ ë¶ˆëª…í™•

2. **SAFE íŒì •ì´ ë„ˆë¬´ ê´€ëŒ€í•  ìˆ˜ ìˆìŒ**
   - "í˜„ì¬ í™”ë©´/í˜ì´ì§€ ë‚´ìš© ì§ˆë¬¸"ë„ SAFEë¡œ ë¶„ë¥˜
   - ì‚¬ìš©ìê°€ ìŠ¤í¬ë¦°ìƒ·ì´ë‚˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì£¼ì…í•˜ë©´ íšŒí”¼ ê°€ëŠ¥
   - **ê¶Œì¥**: í”„ë¡¬í”„íŠ¸ ì¸ì ì…˜ íƒì§€ ë¡œì§ ì¶”ê°€

3. **ì°¨ë‹¨ëœ ì…ë ¥ì˜ ì‚¬ìš©ì ì‘ë‹µì´ ë¶ˆì¹œì ˆí•¨** (line 16):
```python
PARSE_ERROR_MESSAGE = "ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš” ğŸ™"
```
   - íŒŒì‹± ì˜¤ë¥˜ì™€ ì°¨ë‹¨ì„ êµ¬ë¶„í•˜ì§€ ì•ŠìŒ
   - ì‚¬ìš©ì ì…ë ¥ì´ ì‹¤ì œë¡œ ì°¨ë‹¨ëœ ê±´ì§€ ì•Œ ìˆ˜ ì—†ìŒ

### 5.2 tutor_agent.py (ì‹¤í—˜ ì½”ë“œ)

**í˜„ì¬ ìƒíƒœ**: ì£¼ì„ì— "[EXPERIMENTAL]"ë¡œ í‘œì‹œ

**ë¬¸ì œì **:
- í”„ë¡œë•ì…˜ ì½”ë“œ(`fastapi/app/services/tutor_engine.py`)ì™€ ë³„ë„
- ë‘ ê°€ì§€ ë²„ì „ì˜ íŠœí„° ë¡œì§ ìœ ì§€ ë¹„ìš© ì¦ëŒ€
- **ê¶Œì¥**: ëª…í™•í•œ ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš í•„ìš”

---

## 6. í¬íŠ¸í´ë¦¬ì˜¤ ë° ê±°ë˜ (portfolio.py)

### 6.1 ê±°ë˜ ì‹¤í–‰ ë¡œì§

**ë¬¸ì œì **:

1. **ë™ì‹œì„± ì œì–´ ë¶€ì¬**
   - ë‘ ì‚¬ìš©ìê°€ ë™ì‹œì— ê°™ì€ ì¢…ëª©ì„ ì‚¬ê³  íŒ” ê²½ìš°?
   - í¬íŠ¸í´ë¦¬ì˜¤ ì¡°íšŒ í›„ ê±°ë˜ ì‹¤í–‰ ì‚¬ì´ì˜ race condition
   - **ê¶Œì¥**: íŠ¸ëœì­ì…˜ ê²©ë¦¬ ìˆ˜ì¤€ ê°•í™” (SERIALIZABLE) ë˜ëŠ” ë¶„ì‚° ì ê¸ˆ

2. **í¬íŠ¸í´ë¦¬ì˜¤ ìš”ì•½ ìºì‹œ ë¬´íš¨í™”** (lines 56-63):
```python
async def invalidate_portfolio_summary_cache(user_id: int) -> None:
    try:
        cache = await get_redis_cache()
        await cache.delete(key_portfolio_summary(user_id))
    except Exception:
        pass
```
   - ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ â†’ **ìºì‹œ ë¶ˆì¼ì¹˜**
   - **ê¶Œì¥**: ìµœì†Œí•œ ë¡œê·¸ ë° ëª¨ë‹ˆí„°ë§

3. **ì£¼ê°€ ì¡°íšŒì˜ ë°±ì—”ë“œ ì˜ì¡´ì„±** (line 46):
```python
from app.services.stock_price_service import get_current_price, get_batch_prices
```
   - ì™¸ë¶€ API(KIS ë“±)ì— ì˜ì¡´
   - ê°€ê²© ì—…ë°ì´íŠ¸ ì§€ì—° â†’ ëª¨ì˜ê±°ë˜ ê²°ê³¼ ë¶€ì •í™•
   - **ê¶Œì¥**: ë§ˆì§€ë§‰ ê°±ì‹  ì‹œê°„ ë…¸ì¶œ + ì˜¤ë˜ëœ ê°€ê²© ê²½ê³ 

---

## 7. ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸

### 7.1 User ëª¨ë¸ (user.py)

```python
id: Mapped[int] = mapped_column(primary_key=True)
email: Mapped[str] = mapped_column(String(255), unique=True, ...)
username: Mapped[str] = mapped_column(String(50), unique=True, ...)
password_hash: Mapped[str] = mapped_column(String(255), ...)
difficulty_level: Mapped[str] = mapped_column(String(20), default="beginner")
```

**ë¬¸ì œì **:

1. **ì´ë©”ì¼ ì •ê·œí™” ë¶€ì¬**
   - `Email@Example.COM`ê³¼ `email@example.com` ë‹¤ë¥´ê²Œ ì²˜ë¦¬ë¨
   - **ê¶Œì¥**: ì €ì¥ ì „ ì†Œë¬¸ìë¡œ ì •ê·œí™”

2. **ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ ê¸¸ì´ ë¶€ì¡±** (255ì)
   - bcryptì˜ ê¸°ë³¸ hash ê¸¸ì´ëŠ” 60ìì´ë‚˜ ê´œì°®ìŒ
   - **í•˜ì§€ë§Œ**: Argon2 ì‚¬ìš© ì‹œ ìµœëŒ€ ~92ì í•„ìš”

3. **íƒ€ì„ìŠ¤íƒ¬í”„ ë¬¸ì œ**:
```python
created_at: Mapped[datetime] = mapped_column(default=datetime.utcnow)
```
   - `datetime.utcnow()`ëŠ” UTC ë°˜í™˜
   - **ë¬¸ì œ**: KST ê¸°ì¤€ ë°ì´íŠ¸ í•„ìš”í•œ ê²½ìš° í˜¼ë™
   - **ê¶Œì¥**: `created_at_utc` + `created_at_kst` ë˜ëŠ” ì„¤ì • í†µì¼

### 7.2 TutorSession/TutorMessage ëª¨ë¸ (tutor.py)

```python
session_uuid: Mapped[str] = mapped_column(UUID(as_uuid=True), unique=True, default=uuid4)
```

**ë¬¸ì œì **:

1. **Message ë‚´ìš©ì´ í‰ë¬¸ìœ¼ë¡œ ì €ì¥** (line 51):
```python
content: Mapped[str] = mapped_column(Text, nullable=False)
```
   - ë¯¼ê°í•œ ì§ˆë¬¸ ë…¸ì¶œ
   - **ê¶Œì¥**: ì•”í˜¸í™” ì»¬ëŸ¼ ë˜ëŠ” ë³„ë„ ì•”í˜¸í™” ì„œë¹„ìŠ¤

2. **ì¸ë±ìŠ¤ ë¶€ì¡±**:
```python
Index("ix_tutor_sessions_user_id", "user_id"),
Index("ix_tutor_sessions_session_uuid", "session_uuid"),
```
   - `(user_id, created_at)` ë³µí•© ì¸ë±ìŠ¤ ë¶€ì¬
   - ì‚¬ìš©ìì˜ ëª¨ë“  ì„¸ì…˜ ì¡°íšŒ ì‹œ ì„±ëŠ¥ ì €í•˜

---

## 8. ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…

### 8.1 ì „ì—­ ì˜ˆì™¸ í•¸ë“¤ëŸ¬

**ì¢‹ì€ ì **:
- error_id ìƒì„±ìœ¼ë¡œ ë¡œê·¸ ì¶”ì  ê°€ëŠ¥
- ë¯¼ê° ì •ë³´ ë…¸ì¶œ ë°©ì§€

**ë¬¸ì œì **:

1. **ë¡œê·¸ ë ˆë²¨ ê³¼ë‹¤**:
```python
logger.error("Unhandled exception ... \n%s", traceback.format_exc())
```
   - ëª¨ë“  ë¯¸ì²˜ë¦¬ ì˜ˆì™¸ê°€ ERRORë¡œ ê¸°ë¡
   - **ê¶Œì¥**: DEBUG ë˜ëŠ” WARNINGìœ¼ë¡œ ë¶„ë¥˜

2. **ë¡œê¹… êµ¬ì¡°í™” ë¯¸í¡**:
   - JSON í¬ë§· ì‚¬ìš© (ì„¤ì • O) í•˜ì§€ë§Œ ë¶ˆì¼ì¹˜ ìˆìŒ
   - ê° ë¼ìš°íŠ¸ë³„ ë¡œê¹… í‘œì¤€ ë¶€ì¬

---

## 9. Redis ìºì‹±

### 9.1 redis_cache.py

**ë¬¸ì œì **:

1. **TTL ì„¤ì •ì´ í•˜ë“œì½”ë”©ë¨** (lines 23-27):
```python
TTL_TERM_EXPLANATION = 60 * 60 * 24  # 24ì‹œê°„
TTL_GLOSSARY = 60 * 60 * 24  # 24ì‹œê°„
TTL_USER_SETTINGS = 60 * 60 * 2  # 2ì‹œê°„
```
   - ë™ì  ì¡°ì • ë¶ˆê°€ëŠ¥
   - **ê¶Œì¥**: ì„¤ì •ì—ì„œ ì™¸ë¶€í™”

2. **ìºì‹œ ë¯¸ìŠ¤ ì‹œ í´ë°±ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ**:
```python
async def get_term_explanation(self, term: str, difficulty: str = "beginner") -> Optional[str]:
    if not self._is_available():
        return None
```
   - `None` ë°˜í™˜ í›„ í˜¸ì¶œìê°€ DB ì¡°íšŒ?
   - **ê¶Œì¥**: ëª…ì‹œì  ì—ëŸ¬ ë˜ëŠ” ìºì‹œ íˆ¬ëª…ì„±

3. **ì—°ê²° í’€ ê´€ë¦¬**:
```python
self._pool = redis.ConnectionPool.from_url(..., max_connections=50)
```
   - 50ê°œ ì—°ê²°ì€ ë§ì„ ìˆ˜ ìˆìŒ
   - **ê¶Œì¥**: ë¶€í•˜ í…ŒìŠ¤íŠ¸ ê¸°ë°˜ ì¡°ì •

---

## 10. Rate Limiting

### 10.1 rate_limit.py (Lua ìŠ¤í¬ë¦½íŠ¸)

**ì¢‹ì€ ì **:
- ì›ìì  ìŠ¬ë¼ì´ë”© ìœˆë„ìš° êµ¬í˜„
- Redis ê¸°ë°˜ìœ¼ë¡œ ë¶„ì‚° í™˜ê²½ ì§€ì›

**ë¬¸ì œì **:

1. **ì œì™¸ ê²½ë¡œê°€ ë„ˆë¬´ ë§ìŒ** (line 39):
```python
_EXEMPT_PATHS = {"/metrics", "/docs", "/redoc", "/openapi.json", "/"}
```
   - ì¸ì¦ ë¼ìš°íŠ¸(`/auth/*`)ê°€ rate limit ëŒ€ìƒ (ì •ìƒ)
   - **ê¶Œì¥**: ì‚¬ìš©ìë³„ rate limitë„ ì¶”ê°€ (API í‚¤ ê¸°ë°˜)

2. **ì—ëŸ¬ ì²˜ë¦¬ì˜ ì¶”ì ì„± ë¶€ì¡±** (line 75):
```python
except Exception as e:
    logger.warning(f"RateLimit Redis error (fallback=allow): {e}")
```
   - **ë¬¸ì œ**: Redis ì˜¤ë¥˜ ì‹œ ë¬´ì œí•œ í—ˆìš© (DoS ë²¡í„°)
   - **ê¶Œì¥**: ì•ˆì „í•œ fallback (ê±°ë¶€ ë˜ëŠ” ì œí•œëœ ì„ê³„ê°’)

---

## 11. ë°ì´í„° íŒŒì´í”„ë¼ì¸ DB ì €ì¥

### 11.1 datapipeline/db/writer.py

**ë¬¸ì œì **:

1. **DATABASE_URL ì²˜ë¦¬ì˜ í˜¼ë™** (lines 26-31):
```python
def _get_database_url() -> Optional[str]:
    url = os.getenv("DATABASE_URL", "")
    if not url:
        return None
    return url.replace("+asyncpg", "").replace("postgresql://", "postgresql://")
```
   - **ë²„ê·¸**: `postgresql://`ë¥¼ `postgresql://`ë¡œ ì¹˜í™˜ (ì˜ë„ ì—†ìŒ)
   - **ì˜ë„**ëŠ” ì•„ë§ˆë„ `postgresql+asyncpg://` â†’ `postgresql://` (ë™ê¸° ë“œë¼ì´ë²„)
   - **ê¶Œì¥**: ëª…í™•í•œ URL ë³€í™˜ í•¨ìˆ˜

2. **asyncpg ì„í¬íŠ¸ ì²´í¬** (lines 56-60):
```python
try:
    import asyncpg
except ImportError:
    logger.warning("asyncpg ë¯¸ì„¤ì¹˜ â€” DB ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.")
    return {"skipped": True, "reason": "asyncpg not installed"}
```
   - **runtime importëŠ” ìµœëŒ€í•œ í”¼í•´ì•¼ í•¨**
   - **ê¶Œì¥**: í”„ë¡œì íŠ¸ ì‹œì‘ ì‹œ í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸

3. **íŠ¸ëœì­ì…˜ ë¡¤ë°± ë¯¸ì²˜ë¦¬** (lines 62-66):
```python
conn = await asyncpg.connect(db_url)
try:
    return await _save(conn, full_output, briefing_date)
finally:
    await conn.close()
```
   - ì˜ˆì™¸ ë°œìƒ ì‹œ ìë™ ë¡¤ë°± ì—¬ë¶€ ë¶ˆëª…í™•
   - **ê¶Œì¥**: ëª…ì‹œì  `BEGIN` / `ROLLBACK` ë˜ëŠ” context manager

---

## 12. Keywords & Briefings ë¼ìš°íŠ¸

### 12.1 keywords.py

**ë¬¸ì œì **:

1. **ìºì‹œ í‚¤ ìƒì„±ì˜ ì¼ê´€ì„±** (line 58):
```python
cache_key = key_keywords_today(target_date_str)
cached = await cache.get(cache_key)
```
   - `key_keywords_today()` í•¨ìˆ˜ ì •ì˜ ìœ„ì¹˜ ëª…í™•í•˜ì§€ ì•ŠìŒ
   - **ê¶Œì¥**: ëª¨ë“  ìºì‹œ í‚¤ë¥¼ `redis_keys.py`ì— ì •ì˜

2. **ë‚ ì§œ í¬ë§· í˜¼ë™** (lines 48-54):
```python
target_date = datetime.strptime(date.replace("-", ""), "%Y%m%d").date()
target_date_str = target_date.strftime("%Y%m%d")
```
   - `date` ì¿¼ë¦¬ ë§¤ê°œë³€ìˆ˜ê°€ ì—¬ëŸ¬ í¬ë§· ì§€ì›í•˜ì§€ ì•ŠìŒ
   - **ê¶Œì¥**: ISO 8601 (`YYYY-MM-DD`)ë§Œ ì§€ì›

3. **DB í´ë°±ì´ lazy** (lines 74-79):
```python
fallback_stmt = (
    select(DailyBriefing)
    .where(DailyBriefing.top_keywords.isnot(None))
    .order_by(DailyBriefing.briefing_date.desc())
    .limit(1)
)
```
   - ê°€ì¥ ìµœê·¼ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ë˜, **ì‚¬ìš©ìì—ê²Œ ë‚ ì§œê°€ ë‹¤ë¥´ë‹¤ëŠ” ê²ƒì„ ì•Œë¦¬ì§€ ì•ŠìŒ**
   - **ê¶Œì¥**: ì‘ë‹µì— `actual_date` í•„ë“œ ì¶”ê°€

---

## 13. ë³´ì•ˆ ì¢…í•© í‰ê°€

### ì‹¬ê°ë„ ìˆœìœ„:

**ğŸ”´ ë†’ìŒ (ì¦‰ì‹œ ìˆ˜ì •)**:
1. JWT SECRET ê¸°ë³¸ê°’ (line 28 config.py)
2. Access Token íê¸° ë¶ˆê°€ëŠ¥ (í† í° íƒˆì·¨ í›„ ë§Œë£Œê¹Œì§€ ì‚¬ìš© ê°€ëŠ¥)
3. ë©”ì‹œì§€ ë‚´ìš© í‰ë¬¸ ì €ì¥ (tutor.py ëª¨ë¸)
4. í† í° í”„ë¦¬í”½ìŠ¤ ë¡œê¹… (auth.py)

**ğŸŸ¡ ì¤‘ê°„ (ê³§)**:
1. Null byte paddingì„ ì‚¬ìš©í•œ ì•½í•œ JWT í‚¤ (auth.py)
2. Rate limit Redis ì˜¤ë¥˜ ì‹œ ë¬´ì œí•œ í—ˆìš© (rate_limit.py)
3. ê°€ë“œë ˆì¼ ì°¨ë‹¨ í›„ DB ì €ì¥ ë¡œì§ (tutor.py)

**ğŸŸ¢ ë‚®ìŒ (ê°œì„ )**:
1. CORS ì„¤ì • ê²€ì¦ (config.py)
2. ì´ë©”ì¼ ì •ê·œí™” (user model)
3. ìºì‹œ ë¬´íš¨í™” ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ (portfolio.py)

---

## 14. ì„±ëŠ¥ ê´€ë ¨ ì´ìŠˆ

### N+1 ë¬¸ì œ:
- **tutor.py**: ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘ ì‹œ ì—¬ëŸ¬ ì¿¼ë¦¬ (lines 231-264)
- **portfolio.py**: í¬íŠ¸í´ë¦¬ì˜¤ ì¡°íšŒ í›„ ë³´ìœ  ì¢…ëª© ì¶”ê°€ ì¿¼ë¦¬

### íƒ€ì„ì•„ì›ƒ:
- **OpenAI**: 180ì´ˆ (ë„ˆë¬´ ê¹€)
- **SSE ìŠ¤íŠ¸ë¦¬ë°**: 300ì´ˆ (ë„ˆë¬´ ê¹€)

### ë™ì‹œì„±:
- **LLM**: `LLM_MAX_CONCURRENCY=6` (ë³‘ëª© ê°€ëŠ¥)
- **DB í’€**: `pool_size=50 + max_overflow=100` (ê³¼ë„í•¨)

---

## 15. í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€

**í˜„ì¬ ìƒíƒœ**:
- `tests/` ë””ë ‰í† ë¦¬ ì¡´ì¬
- ì£¼ìš” íŒŒì¼ ì—†ìŒ (viz_test_outputë§Œ ì¡´ì¬)

**ê¶Œì¥**:
```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ test_auth_service.py
â”‚   â”œâ”€â”€ test_guardrail.py
â”‚   â””â”€â”€ test_redis_cache.py
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ test_tutor_chat.py
â”‚   â””â”€â”€ test_portfolio_trading.py
â””â”€â”€ conftest.py (fixtures)
```

---

## ì¢…í•© ê°œì„  ë¡œë“œë§µ

### Phase 1 (ì¦‰ì‹œ - 2ì£¼):
1. JWT SECRET ê°•ì œ ì„¤ì • + ìœ íš¨ì„± ê²€ì¦
2. ë©”ì‹œì§€ ë‚´ìš© ì•”í˜¸í™” ë˜ëŠ” anonymize
3. í† í° ë¸”ë™ë¦¬ìŠ¤íŠ¸ ë˜ëŠ” Access Token ë§Œë£Œ ì‹œê°„ ë‹¨ì¶•
4. ê°€ë“œë ˆì¼ ì°¨ë‹¨ ì‹œ DB ì €ì¥ ë¡œì§ ì œê±°

### Phase 2 (1ê°œì›”):
1. tutor.py ë¦¬íŒ©í† ë§ (í•¨ìˆ˜ ë¶„ë¦¬: context ìˆ˜ì§‘, LLM í˜¸ì¶œ, ì‹œê°í™”, ì €ì¥)
2. N+1 ì¿¼ë¦¬ ìµœì í™” (ë°°ì¹˜ ë¡œë”© ë˜ëŠ” ë‹¨ì¼ ì¿¼ë¦¬)
3. Rate limit ê°œì„  (ì‚¬ìš©ìë³„ ì œí•œ ì¶”ê°€)
4. í…ŒìŠ¤íŠ¸ ì‘ì„± (ìœ ë‹› + í†µí•©)

### Phase 3 (2ê°œì›”):
1. datapipeline State ì •ë¦¬ (TypedDict â†’ dataclass)
2. ë…¸ë“œë³„ ì˜¤ë¥˜ ì²˜ë¦¬ ë° ì¬ì‹œë„ ë¡œì§
3. íŠœí„° ì—ì´ì „íŠ¸ ë§ˆì´ê·¸ë ˆì´ì…˜ (LangGraph)
4. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

---

## í•µì‹¬ ê°œì„  ì½”ë“œ ì˜ˆì‹œ

### 1. JWT SECRET ìœ íš¨ì„± ê²€ì¦:
```python
# config.pyì—ì„œ
def validate_jwt_secret(secret: str) -> None:
    if not secret or secret == "narrative-invest-jwt-secret-change-in-production":
        raise ValueError("JWT_SECRET must be set to a strong, unique value")
    if len(secret.encode('utf-8')) < 32:
        raise ValueError("JWT_SECRET must be at least 32 bytes")

# main.pyì—ì„œ startup
@app.on_event("startup")
async def startup():
    validate_jwt_secret(settings.JWT_SECRET)
```

### 2. tutor.py ë¦¬íŒ©í† ë§:
```python
async def _collect_context(
    request: TutorChatRequest, 
    db: AsyncSession
) -> dict:
    """ì»¨í…ìŠ¤íŠ¸ë§Œ ìˆ˜ì§‘ (SRP)"""
    return {"briefing": ..., "portfolio": ...}

async def _call_llm(
    messages: list,
    api_key: str
) -> AsyncGenerator[str, None]:
    """LLM í˜¸ì¶œë§Œ ìˆ˜í–‰"""
    async for chunk in ...
        yield chunk

async def _save_session(
    db: AsyncSession,
    session: TutorSession,
    messages: list[TutorMessage]
) -> None:
    """DB ì €ì¥ë§Œ ìˆ˜í–‰"""
    db.add_all(messages)
    await db.commit()
```

### 3. ë©”ì‹œì§€ ì•”í˜¸í™”:
```python
# models/tutor.py
from cryptography.fernet import Fernet

class TutorMessage(Base):
    content_encrypted: Mapped[str] = mapped_column(String, nullable=False)
    
    @property
    def content(self) -> str:
        cipher = Fernet(os.getenv("MESSAGE_CIPHER_KEY"))
        return cipher.decrypt(self.content_encrypted).decode()
```

---

## ê²°ë¡ 

Adelie Investment ë°±ì—”ë“œëŠ” **ì „ë°˜ì ìœ¼ë¡œ ê±´ì „í•œ ì•„í‚¤í…ì²˜**ë¥¼ ê°€ì§€ê³  ìˆìœ¼ë‚˜, **ë³´ì•ˆ, ì„±ëŠ¥, í…ŒìŠ¤íŠ¸ ì¸¡ë©´ì—ì„œ ê°œì„ **ì´ í•„ìš”í•©ë‹ˆë‹¤.

íŠ¹íˆ:
- âœ… FastAPI, SQLAlchemy, Redis ê¸°ë°˜ì˜ ëª¨ë˜ ìŠ¤íƒ
- âœ… LangGraphë¥¼ í†µí•œ íŒŒì´í”„ë¼ì¸ ì¡°ì§í™”
- âœ… ë¼ìš°íŠ¸ ë™ì  ë¡œë”©ìœ¼ë¡œ ëª¨ë“ˆì„± í™•ë³´

í•˜ì§€ë§Œ:
- âŒ ì¤‘ë³µëœ í† í° ê´€ë¦¬ ì„¤ì •
- âŒ tutor.pyì˜ ì±…ì„ ê³¼ë‹¤ (512ì¤„)
- âŒ ë°ì´í„° ì•”í˜¸í™” ë¶€ì¡±
- âŒ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê±°ì˜ ì—†ìŒ

**ê¶Œì¥ ìš°ì„ ìˆœìœ„**: ë³´ì•ˆ 3ê°€ì§€ â†’ ë¦¬íŒ©í† ë§ â†’ í…ŒìŠ¤íŠ¸ â†’ ì„±ëŠ¥ ìµœì í™” ìˆœì„œë¡œ ì§„í–‰í•˜ë©´, 3-4ê°œì›” ë‚´ì— í”„ë¡œë•ì…˜ ì¤€ë¹„ ìˆ˜ì¤€ì— ë„ë‹¬í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤.</result>
<usage><total_tokens>75818</total_tokens><tool_uses>36</tool_uses><duration_ms>117366</duration_ms></usage>
</task-notification>
Full transcript available at: REDACTED.output

---

ìˆœì°¨ì ìœ¼ë¡œ ëª¨ë‘ ìˆ˜ì •í•  ê³„íšì„ ì„¸ì›Œë¼. íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤. ë°°í¬ ì„œë²„ ì—…ë°ì´íŠ¸ê¹Œì§€ ëª¨ë‘ ì§„í–‰í•´ì•¼ í•œë‹¤.

---

[Request interrupted by user for tool use]