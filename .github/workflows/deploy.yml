name: Deploy

on:
  push:
    branches: [develop]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: dorae222
  TAG: latest

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------
      # Build Docker images
      # -----------------------------------------------
      - name: Build frontend image
        run: docker build -t ${{ env.REGISTRY }}/adelie-frontend:${{ env.TAG }} ./frontend

      - name: Build backend-api image
        run: docker build -f fastapi/Dockerfile -t ${{ env.REGISTRY }}/adelie-backend-api:${{ env.TAG }} .

      - name: Build ai-pipeline image
        run: docker build -f datapipeline/Dockerfile -t ${{ env.REGISTRY }}/adelie-ai-pipeline:${{ env.TAG }} .

      # -----------------------------------------------
      # Push to Docker Hub
      # -----------------------------------------------
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push images
        run: |
          docker push ${{ env.REGISTRY }}/adelie-frontend:${{ env.TAG }}
          docker push ${{ env.REGISTRY }}/adelie-backend-api:${{ env.TAG }}
          docker push ${{ env.REGISTRY }}/adelie-ai-pipeline:${{ env.TAG }}

      # -----------------------------------------------
      # Deploy to deploy-test server
      # -----------------------------------------------
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            cd ~/adelie-investment
            git pull origin develop
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            docker exec adelie-frontend nginx -s reload 2>/dev/null || true

      # -----------------------------------------------
      # Health check
      # -----------------------------------------------
      - name: Health check
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            echo "Waiting for services to start..."
            sleep 15

            # Backend API health
            for i in 1 2 3 4 5; do
              if curl -sf http://localhost:8082/api/v1/health > /dev/null 2>&1; then
                echo "Backend API: healthy"
                break
              fi
              echo "Attempt $i/5 - waiting..."
              sleep 5
            done

            # Frontend health
            if curl -sf http://localhost:80 > /dev/null 2>&1; then
              echo "Frontend: healthy"
            else
              echo "Frontend: unhealthy"
              exit 1
            fi

      # -----------------------------------------------
      # Discord notification (success)
      # -----------------------------------------------
      - name: Discord notification (success)
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1 | jq -Rs '.')

          curl -sf -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \":white_check_mark: Deploy Succeeded\",
                \"color\": 3066993,
                \"fields\": [
                  {\"name\": \"Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                  {\"name\": \"Author\", \"value\": \"**${{ github.actor }}**\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": $COMMIT_MSG}
                ],
                \"url\": \"${{ github.event.head_commit.url }}\",
                \"footer\": {\"text\": \"${{ github.repository }}\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK"

      # -----------------------------------------------
      # Discord notification (failure)
      # -----------------------------------------------
      - name: Discord notification (failure)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          COMMIT_MSG=$(echo "${{ github.event.head_commit.message }}" | head -1 | jq -Rs '.')

          curl -sf -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \":x: Deploy Failed\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \"Branch\", \"value\": \"\`${{ github.ref_name }}\`\", \"inline\": true},
                  {\"name\": \"Author\", \"value\": \"**${{ github.actor }}**\", \"inline\": true},
                  {\"name\": \"Commit\", \"value\": $COMMIT_MSG},
                  {\"name\": \"Run\", \"value\": \"[View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\"}
                ],
                \"footer\": {\"text\": \"${{ github.repository }}\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "$DISCORD_WEBHOOK"
