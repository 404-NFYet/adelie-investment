# ============================================================
# lxd/Makefile â€” ì¸í”„ë¼ ì „ìš© (dorae222/hj ì„œë²„ì—ì„œë§Œ ì‹¤í–‰)
# ì‚¬ìš©ë²•: make -f lxd/Makefile <target>
# ============================================================

ROOT := $(realpath $(dir $(lastword $(MAKEFILE_LIST)))..)
REGISTRY ?= dorae222
TAG ?= latest

.PHONY: help push push-local deploy-test deploy-test-service \
        deploy-staging sync-dev-branches sync-lxd sync-all \
        check-lxd-git sync-dev-data health-lxd fix-lxd-jwt

help:
	@echo ""
	@echo "  [ì¸í”„ë¼ ì „ìš©] lxd/Makefile ëª…ë ¹ì–´"
	@echo "  ì‹¤í–‰: make -f lxd/Makefile <target>"
	@echo ""
	@echo "  Docker Hub ë°°í¬:"
	@echo "    push                   ëª¨ë“  ì´ë¯¸ì§€ Docker Hub push"
	@echo "    push-local             ë¡œì»¬ ë ˆì§€ìŠ¤íŠ¸ë¦¬(10.10.10.10:5000) push"
	@echo "    deploy-test            ë¹Œë“œ â†’ push â†’ deploy-test ì „ì²´ ë°°í¬"
	@echo "    deploy-test-service    ë‹¨ì¼ ì„œë¹„ìŠ¤ ë°°í¬ (SVC=frontend|backend-api|ai-pipeline)"
	@echo ""
	@echo "  ë¸Œëœì¹˜/LXD ì‹±í¬:"
	@echo "    sync-dev-branches      develop â†’ dev/* ë¸Œëœì¹˜ ë³‘í•© & push"
	@echo "    sync-lxd               ê° LXD ì„œë²„ì—ì„œ git pull ì‹¤í–‰"
	@echo "    sync-all               ìœ„ ë‘ ì‘ì—… ìˆœì°¨ ì‹¤í–‰"
	@echo ""
	@echo "  LXD ê°œë°œ í™˜ê²½:"
	@echo "    check-lxd-git          ê° LXD ì„œë²„ git ì„¤ì •(user/email/remote/SSH) ì ê²€"
	@echo "    health-lxd             5ëŒ€ ì„œë²„ git ë¸Œëœì¹˜/Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ í•œëˆˆì— ë³´ê¸°"
	@echo "    fix-lxd-jwt            JWT_SECRET ê¸°ë³¸ê°’ì¸ ì„œë²„ ìë™ ê°±ì‹  + backend-api ì¬ì‹œì‘"
	@echo "    sync-dev-data          prod DB ì½˜í…ì¸  â†’ ê° LXD ë¡œì»¬ dev DB ë™ê¸°í™”"
	@echo ""
	@echo "  ë³€ìˆ˜:"
	@echo "    REGISTRY=$(REGISTRY)  TAG=$(TAG)"
	@echo ""

# --- Docker Hub Push ---
push:
	@echo "Docker Hub($(REGISTRY)) push..."
	docker push $(REGISTRY)/adelie-frontend:$(TAG)
	docker push $(REGISTRY)/adelie-backend-api:$(TAG)
	docker push $(REGISTRY)/adelie-ai-pipeline:$(TAG)

push-local:
	@for svc in frontend backend-api ai-pipeline; do \
		docker tag $(REGISTRY)/adelie-$$svc:$(TAG) 10.10.10.10:5000/adelie-$$svc:$(TAG); \
		docker push 10.10.10.10:5000/adelie-$$svc:$(TAG); \
	done

# --- Deploy-test (10.10.10.20) ---
deploy-test:
	$(MAKE) -C $(ROOT) build
	$(MAKE) push
	ssh deploy-test 'cd ~/adelie-investment && git pull origin develop && \
		docker compose -f docker-compose.prod.yml pull && \
		docker compose -f docker-compose.prod.yml up -d --remove-orphans && \
		docker exec adelie-frontend nginx -s reload 2>/dev/null || true'

deploy-test-service:
	$(MAKE) -C $(ROOT) build-$(SVC)
	docker push $(REGISTRY)/adelie-$(SVC):$(TAG)
	ssh deploy-test 'cd ~/adelie-investment && git pull origin develop && \
		docker compose -f docker-compose.prod.yml pull $(SVC) && \
		docker compose -f docker-compose.prod.yml up -d $(SVC) && \
		docker exec adelie-frontend nginx -s reload 2>/dev/null || true'

# --- ë¸Œëœì¹˜ ì‹±í¬ (í˜„ì¬ git ê³„ì • ì‚¬ìš© â€” git config ê°•ì œ ë³€ê²½ ì—†ìŒ) ---
sync-dev-branches:
	@echo "develop â†’ dev/* ë¸Œëœì¹˜ ì‹±í¬..."
	@cd $(ROOT) && CURRENT=$$(git branch --show-current); \
	for BRANCH in dev/frontend dev/backend dev/chatbot dev/pipeline dev/infra; do \
		echo "  -> $$BRANCH"; \
		git checkout $$BRANCH 2>/dev/null || { echo "  ë¸Œëœì¹˜ ì—†ìŒ, ê±´ë„ˆëœ€: $$BRANCH"; continue; }; \
		git merge develop --no-edit 2>/dev/null || true; \
		git push origin $$BRANCH; \
	done; \
	git checkout $$CURRENT
	@echo "ì™„ë£Œ: ëª¨ë“  dev/* ë¸Œëœì¹˜ ì‹±í¬"

# --- LXD ì„œë²„ ì½”ë“œ ì‹±í¬ (lxc ëª…ë ¹ â€” í˜¸ìŠ¤íŠ¸ì—ì„œë§Œ ë™ì‘) ---
# git pull í›„ frontend dev ì´ë¯¸ì§€ ë¹Œë“œ ë° up -d í¬í•¨
sync-lxd:
	@echo "LXD ì„œë²„ ì½”ë“œ ì‹±í¬ (git pull â†’ frontend build â†’ up -d)..."
	@lxc exec dev-yj99son  -- bash -c "cd /home/ubuntu/adelie-investment && git pull origin dev/frontend && \
		docker compose -f docker-compose.dev.yml build frontend 2>&1 | tail -3 && \
		docker compose -f docker-compose.dev.yml up -d frontend" && echo "  âœ… dev-yj99son" || echo "  âŒ dev-yj99son"
	@lxc exec dev-j2hoon10 -- bash -c "cd /home/ubuntu/adelie-investment && git pull origin dev/chatbot && \
		docker compose -f docker-compose.dev.yml build frontend 2>&1 | tail -3 && \
		docker compose -f docker-compose.dev.yml up -d frontend" && echo "  âœ… dev-j2hoon10" || echo "  âŒ dev-j2hoon10"
	@lxc exec dev-ryejinn  -- bash -c "cd /home/ubuntu/adelie-investment && git pull origin dev/pipeline && \
		docker compose -f docker-compose.dev.yml build frontend 2>&1 | tail -3 && \
		docker compose -f docker-compose.dev.yml up -d frontend" && echo "  âœ… dev-ryejinn" || echo "  âŒ dev-ryejinn"
	@lxc exec dev-jjjh02   -- bash -c "cd /home/ubuntu/adelie-investment && git pull origin dev/backend && \
		docker compose -f docker-compose.dev.yml build frontend 2>&1 | tail -3 && \
		docker compose -f docker-compose.dev.yml up -d frontend" && echo "  âœ… dev-jjjh02" || echo "  âŒ dev-jjjh02"
	@lxc exec dev-hj       -- bash -c "cd /home/ubuntu/adelie-investment && git pull origin dev/infra && \
		docker compose -f docker-compose.dev.yml build frontend 2>&1 | tail -3 && \
		docker compose -f docker-compose.dev.yml up -d frontend" && echo "  âœ… dev-hj" || echo "  âŒ dev-hj"
	@echo "ì™„ë£Œ: ëª¨ë“  LXD ì„œë²„ ì½”ë“œ ì‹±í¬"

# --- Staging (10.10.10.21) ---
deploy-staging:
	ssh staging 'cd ~/adelie-investment && git pull origin develop && \
		docker compose -f docker-compose.staging.yml pull && \
		docker compose -f docker-compose.staging.yml up -d --remove-orphans'
	@echo "âœ… staging(10.10.10.21) ë°°í¬ ì™„ë£Œ"

sync-all: sync-dev-branches sync-lxd
	@echo "ì „ì²´ ì‹±í¬ ì™„ë£Œ (ë¸Œëœì¹˜ + LXD ì„œë²„)"

# --- LXD ì„œë²„ git ì„¤ì • ì ê²€ ---
check-lxd-git:
	@echo "=== LXD ì„œë²„ git ì„¤ì • ì ê²€ ==="
	@for srv in dev-yj99son dev-j2hoon10 dev-jjjh02 dev-ryejinn dev-hj; do \
		echo ""; \
		echo "### $$srv ###"; \
		lxc exec $$srv -- bash -c " \
			cd /home/ubuntu/adelie-investment 2>/dev/null || { echo '  âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ'; exit 0; }; \
			REMOTE=\$$(git remote get-url origin 2>/dev/null | sed 's|https://[^@]*@|https://***@|g' || echo 'ë¯¸ì„¤ì •'); \
			NAME=\$$(git config user.name 2>/dev/null || echo 'âŒ ë¯¸ì„¤ì •'); \
			EMAIL=\$$(git config user.email 2>/dev/null || echo 'âŒ ë¯¸ì„¤ì •'); \
			SSH_RESULT=\$$(ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 -T git@github.com 2>&1 | grep -v '^Warning:' | head -1 || true); \
			[ -z \"\$$SSH_RESULT\" ] && SSH_RESULT='âŒ SSH ë¯¸ì¸ì¦ (ê³µê°œí‚¤ GitHub ë¯¸ë“±ë¡)'; \
			echo \"  remote : \$$REMOTE\"; \
			echo \"  user   : \$$NAME <\$$EMAIL>\"; \
			echo \"  ssh    : \$$SSH_RESULT\"; \
		" 2>/dev/null || echo "  âŒ LXC ì—°ê²° ì‹¤íŒ¨"; \
	done
	@echo ""
	@echo "=== ì ê²€ ì™„ë£Œ ==="

# --- prod DB ì½˜í…ì¸  â†’ ê° LXD ë¡œì»¬ dev DB ë™ê¸°í™” ---
# HOST(dev-hj)ì—ì„œ ì‹¤í–‰: deploy-test prod ë¤í”„ â†’ ê° LXD ì„œë²„ ë¡œì»¬ postgresì— ì ìš©
sync-dev-data:
	@echo "=== deploy-test â†’ ê° LXD ë¡œì»¬ dev DB ì½˜í…ì¸  ë™ê¸°í™” ==="
	@bash $(ROOT)/database/scripts/sync_dev_data.sh
	@echo "=== ë™ê¸°í™” ì™„ë£Œ ==="

# --- LXD 5ëŒ€ ì„œë²„ í—¬ìŠ¤ì²´í¬ (git ë¸Œëœì¹˜ + Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ) ---
health-lxd:
	@echo "=== LXD ì„œë²„ í—¬ìŠ¤ì²´í¬ ==="
	@for srv in dev-yj99son dev-j2hoon10 dev-jjjh02 dev-ryejinn dev-hj; do \
		echo ""; \
		echo "### $$srv ###"; \
		lxc exec $$srv -- bash -c " \
			cd /home/ubuntu/adelie-investment 2>/dev/null || { echo '  âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ'; exit 0; }; \
			BRANCH=\$$(git branch --show-current 2>/dev/null || echo 'â“ ë¯¸í™•ì¸'); \
			AHEAD=\$$(git rev-list @{u}..HEAD 2>/dev/null | wc -l || echo '?'); \
			BEHIND=\$$(git rev-list HEAD..@{u} 2>/dev/null | wc -l || echo '?'); \
			echo \"  ë¸Œëœì¹˜  : \$$BRANCH (â†‘\$$AHEAD â†“\$$BEHIND)\"; \
			echo '  ì»¨í…Œì´ë„ˆ:'; \
			docker compose -f docker-compose.dev.yml ps --format 'table {{.Name}}\t{{.Status}}' 2>/dev/null | tail -n +2 | \
				awk '{printf \"    %-35s %s\n\", \$$1, \$$2}'; \
		" 2>/dev/null || echo "  âŒ LXC ì—°ê²° ì‹¤íŒ¨"; \
	done
	@echo ""
	@echo "=== í—¬ìŠ¤ì²´í¬ ì™„ë£Œ ==="

# --- JWT_SECRET ê¸°ë³¸ê°’ ì„œë²„ ìë™ ìˆ˜ì • ---
# .envì˜ JWT_SECRETì´ ê¸°ë³¸ê°’ì´ë©´ ìƒˆ ëœë¤ê°’ìœ¼ë¡œ êµì²´ í›„ backend-api ì¬ì‹œì‘
fix-lxd-jwt:
	@echo "=== JWT_SECRET ê¸°ë³¸ê°’ ì„œë²„ ìˆ˜ì • ==="
	@DEFAULT_JWT="narrative-invest-jwt-secret-change-in-production"; \
	for srv in dev-yj99son dev-j2hoon10 dev-jjjh02 dev-ryejinn dev-hj; do \
		echo ""; \
		echo "### $$srv ###"; \
		lxc exec $$srv -- bash -c " \
			ENV_FILE=\$$(ls /home/ubuntu/adelie-investment/.env 2>/dev/null | head -1); \
			[ -z \"\$$ENV_FILE\" ] && { echo '  âŒ .env íŒŒì¼ ì—†ìŒ'; exit 0; }; \
			DIR=\$$(dirname \$$ENV_FILE); \
			CURRENT_JWT=\$$(grep '^JWT_SECRET=' \$$ENV_FILE | cut -d= -f2-); \
			if [ \"\$$CURRENT_JWT\" = 'narrative-invest-jwt-secret-change-in-production' ]; then \
				NEW_JWT=\$$(openssl rand -hex 32); \
				sed -i \"s|JWT_SECRET=.*|JWT_SECRET=\$$NEW_JWT|\" \$$ENV_FILE; \
				echo '  ğŸ”§ JWT_SECRET ê°±ì‹  ì™„ë£Œ'; \
				cd \$$DIR && docker compose -f docker-compose.dev.yml restart backend-api 2>&1 | tail -2; \
				sleep 8; \
				STATUS=\$$(docker compose -f docker-compose.dev.yml ps backend-api --format '{{.Status}}' 2>/dev/null); \
				echo \"  ìƒíƒœ: \$$STATUS\"; \
			else \
				echo '  âœ… JWT_SECRET ì •ìƒ (ê¸°ë³¸ê°’ ì•„ë‹˜)'; \
			fi; \
		" 2>/dev/null || echo "  âŒ LXC ì—°ê²° ì‹¤íŒ¨"; \
	done
	@echo ""
	@echo "=== JWT ìˆ˜ì • ì™„ë£Œ ==="
